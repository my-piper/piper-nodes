<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Image Generation</title>

    <!-- Tailwind CSS compiled -->
    <link rel="stylesheet" href="../../../styles/ui.css" />

    <!-- Vue.js -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <!-- Fonts -->
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap");
    </style>

    <style>
      /* Custom range slider styling for template weight control */
      input[type="range"] {
        -webkit-appearance: none;
        appearance: none;
        background: transparent;
        cursor: pointer;
      }

      input[type="range"]::-webkit-slider-runnable-track {
        width: 100%;
        height: 4px;
        background: #535353;
        border-radius: 2px;
      }

      input[type="range"]::-moz-range-track {
        width: 100%;
        height: 4px;
        background: #535353;
        border-radius: 2px;
        border: none;
      }

      input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 18px;
        height: 18px;
        background: #aaaaaa;
        cursor: pointer;
        border-radius: 50%;
        margin-top: -7px;
        transition: background 0.2s ease;
      }

      input[type="range"]::-webkit-slider-thumb:hover {
        background: #eaeaea;
      }

      input[type="range"]::-moz-range-thumb {
        width: 18px;
        height: 18px;
        background: #aaaaaa;
        cursor: pointer;
        border-radius: 50%;
        border: none;
        transition: background 0.2s ease;
      }

      input[type="range"]::-moz-range-thumb:hover {
        background: #eaeaea;
      }

      /* Grid layout for templates */
      .templates-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 12px;
        padding: 12px;
      }
    </style>
  </head>
  <body
    class="bg-graphite-600 text-white font-sans text-sm antialiased m-0 p-0"
  >
    <script type="text/x-template" id="app-tpl">
      <div v-if="error" class="flex justify-center items-center h-screen text-red text-base">
        {{ error }}
      </div>
      <template v-else>
        <!-- Current Templates Section -->
        <div v-if="currentTemplates.length > 0" class="p-3 mb-0 bg-graphite-600 border-b border-graphite-300 flex-shrink-0">
          <div class="grid grid-cols-3 gap-2 w-full">
            <div
              v-for="(template, index) in currentTemplates"
              :key="index"
              class="flex items-start gap-1.5 p-2 pr-7 bg-graphite-500 border border-graphite-200 rounded-md text-[13px] text-white min-w-0 overflow-hidden transition-colors hover:bg-graphite-400 hover:border-graphite-100 relative"
            >
              <img
                v-if="template.thumbnail"
                :src="template.thumbnail"
                :alt="template.name"
                class="w-8 h-8 object-cover rounded-sm flex-shrink-0"
              />
              <div class="flex flex-col gap-0.5 flex-1 min-w-0 overflow-hidden">
                <div class="font-bold whitespace-nowrap overflow-hidden text-ellipsis w-full">
                  {{ template.name }}
                </div>
                <div class="flex items-center gap-1.5">
                  <input
                    type="range"
                    :value="template.weight"
                    @input="updateWeight(index, $event.target.value)"
                    min="0"
                    max="2"
                    step="0.1"
                    class="flex-1 h-1 m-0 p-0"
                  />
                  <span class="text-[13px] text-white min-w-[32px] text-right font-medium">
                    {{ template.weight.toFixed(1) }}
                  </span>
                </div>
              </div>
              <button
                @click="removeTemplate(index)"
                title="Remove template"
                class="absolute top-1 right-1 bg-transparent border-none text-graphite-75 cursor-pointer p-0 m-0 text-xl leading-none w-5 h-5 flex items-center justify-center flex-shrink-0 hover:text-red active:scale-90 transition-transform"
              >
                Ã—
              </button>
            </div>
          </div>
        </div>

        <!-- Search Container -->
        <div class="border-b border-graphite-300 p-3 bg-graphite-600">
          <input
            type="text"
            v-model="searchQuery"
            @input="handleSearch"
            placeholder="Search templates..."
            :class="loading ? 'opacity-80' : ''"
            class="w-full px-3 py-2 bg-graphite-500 text-white border border-graphite-200 rounded-md focus:bg-graphite-400 focus:border-graphite-100 focus:outline-none transition-colors"
          />
        </div>

        <!-- Loading State -->
        <div v-if="loading && templates.length === 0" class="flex justify-center items-center h-screen text-xl">
          Loading templates...
        </div>

        <!-- Templates Grid -->
        <template v-else>
          <div class="templates-grid">
            <div
              v-for="template in templates"
              :key="template.id"
              @click="selectTemplate(template)"
              class="overflow-hidden cursor-pointer transition-transform hover:-translate-y-1 p-0 bg-graphite-300 border border-graphite-200 rounded-lg"
            >
              <template v-if="template.lastVersion?.metadata?.samples?.[0]?.preview">
                <video
                  v-if="template.lastVersion.metadata.samples[0].preview.type === 'video'"
                  :src="template.lastVersion.metadata.samples[0].preview.url"
                  autoplay
                  loop
                  muted
                  playsinline
                  class="w-full h-[200px] object-cover block"
                />
                <img
                  v-else
                  :src="template.lastVersion.metadata.samples[0].preview.url"
                  :alt="template.name"
                  class="w-full h-[200px] object-cover block"
                />
              </template>
              <div class="m-0 p-1">
                <h3 :title="template.name" class="m-0 text-[13px] font-bold overflow-hidden text-ellipsis whitespace-nowrap">
                  {{ template.name }}
                </h3>
              </div>
            </div>
          </div>

          <!-- Load More Button -->
          <div class="p-3 text-center">
            <button
              v-if="hasMore"
              @click="loadMore"
              :disabled="loadingMore"
              class="px-4 py-2 bg-graphite-400 text-graphite-50 border border-graphite-200 rounded font-bold hover:bg-graphite-300 hover:border-graphite-75 hover:text-white disabled:opacity-50 disabled:cursor-not-allowed transition-colors cursor-pointer"
            >
              {{ loadingMore ? 'Loading...' : 'Load More' }}
            </button>
            <div v-else class="text-graphite-75 text-sm">
              No more templates
            </div>
          </div>
        </template>
      </template>
    </script>

    <div id="app"></div>

    <script type="module">
      const piper = window.Piper?.create() || {
        appRoot: document.body,
        meta: {},
        inputs: {
          prompt: "cat walking on the Mars",
          templates: JSON.stringify([
            {
              type: "lora",
              name: "Wallace & Gromit",
              fullFileName: "wallace-gromit.safetensors",
              trainedWords: ["Wallace", "Gromit"],
              thumbnail: "https://placehold.co/600x400",
              weight: 0.5,
            },
          ]),
        },
        save({ templates }) {
          console.log(templates);
        },
        close() {
          // nothing
        },
        mode: "dev",
      };

      const { createApp, defineComponent, ref, onMounted } = Vue;

      const App = defineComponent({
        template: piper.appRoot.querySelector("#app-tpl").textContent,
        setup() {
          console.log("Setup called");
          const templates = ref([]);
          const currentTemplates = ref(
            JSON.parse(piper.inputs.templates || "[]")
          );
          const loading = ref(true);
          const loadingMore = ref(false);
          const error = ref(null);
          const cursor = ref(null);
          const pageSize = 40;
          const hasMore = ref(true);
          const searchQuery = ref("");
          let searchTimeout = null;

          // Fetch templates from API
          const fetchTemplates = async (isLoadMore = false) => {
            try {
              if (isLoadMore) {
                loadingMore.value = true;
              } else {
                loading.value = true;
              }
              error.value = null;

              let url = `https://artworks.ai/api/v2/models?baseModel=sdxl&top=${pageSize}`;

              // Add cursor if loading more and we have a cursor
              if (isLoadMore && cursor.value) {
                url += `&cursor=${encodeURIComponent(cursor.value)}`;
              }

              // Add search query if present
              if (searchQuery.value.trim()) {
                url += `&q=${encodeURIComponent(searchQuery.value.trim())}`;
              }
              console.log("Fetching templates from:", url);

              const response = await fetch(url);

              if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
              }

              const data = await response.json();
              console.log("Fetched templates:", data);
              console.log("Templates count:", data.length);

              if (isLoadMore) {
                templates.value = [...templates.value, ...data];
              } else {
                templates.value = data;
              }

              // Get cursor from the last template for next page
              if (data.length > 0) {
                const lastTemplate = data[data.length - 1];

                // Create cursor object with id and sort
                const cursorObj = {
                  id: lastTemplate.id,
                  sort: lastTemplate.sort,
                };

                // Encode cursor as Base64 JSON
                const cursorJson = JSON.stringify(cursorObj);
                cursor.value = btoa(cursorJson);

                console.log(
                  "Last template:",
                  lastTemplate.id,
                  "sort:",
                  lastTemplate.sort
                );
                console.log("Cursor object:", cursorObj);
                console.log("Encoded cursor:", cursor.value);
              }

              // Check if there are more templates to load
              // Only set hasMore to false if we got 0 results or less than page size
              if (data.length === 0 || data.length < pageSize) {
                hasMore.value = false;
                console.log("No more templates available");
              } else {
                console.log(
                  `Got ${data.length} templates, more may be available`
                );
              }
            } catch (err) {
              error.value = `Failed to load templates: ${err.message}`;
              console.error("Error fetching templates:", err);
            } finally {
              loading.value = false;
              loadingMore.value = false;
              console.log(
                "Loading finished. Total templates:",
                templates.value.length
              );
            }
          };

          // Handle search input with debounce
          const handleSearch = () => {
            // Clear existing timeout
            if (searchTimeout) {
              clearTimeout(searchTimeout);
            }

            // Set new timeout to debounce search
            searchTimeout = setTimeout(() => {
              console.log("Searching for:", searchQuery.value);
              // Reset cursor and hasMore for new search
              cursor.value = null;
              hasMore.value = true;
              // Don't clear templates here to prevent jumping
              // fetchTemplates will replace them
              fetchTemplates(false);
            }, 500); // Wait 500ms after user stops typing
          };

          // Load more templates
          const loadMore = () => {
            console.log("Load More clicked!");
            console.log("loadingMore:", loadingMore.value);
            console.log("loading:", loading.value);
            console.log("hasMore:", hasMore.value);

            if (!loadingMore.value && !loading.value && hasMore.value) {
              console.log("Calling fetchTemplates(true)...");
              fetchTemplates(true);
            } else {
              console.log("Conditions not met for loading more");
            }
          };

          // Select a template
          const selectTemplate = (template) => {
            console.log("Selected template:", template);

            // Get trained words from template metadata
            const trainedWords =
              template.lastVersion?.metadata?.trainedWords || [];
            console.log("Trained words:", trainedWords);

            // Get the file name from the last version
            const fullFileName = template.lastVersion.fullFileName;
            console.log("File name:", fullFileName);

            // Get thumbnail from preview
            const thumbnail =
              template.lastVersion?.metadata?.samples?.[0]?.preview?.url ||
              null;

            // Create template object to add to the array
            const newTemplate = {
              type: "lora",
              name: template.name,
              fullFileName,
              trainedWords,
              thumbnail,
              weight: 1.0,
            };

            console.log("Adding template to array:", newTemplate);

            // Add template to current templates array
            currentTemplates.value = [...currentTemplates.value, newTemplate];

            // Scroll to top of the app container
            const container = document.querySelector("#app");
            if (container) {
              container.scrollTo({ top: 0, behavior: "smooth" });
            }

            // Save the updated templates array using piper
            piper.save({
              templates: JSON.stringify(currentTemplates.value, null, 2),
            });
            piper.close();
          };

          // Remove a template from current templates
          const removeTemplate = (index) => {
            console.log("Removing template at index:", index);
            currentTemplates.value = currentTemplates.value.filter(
              (_, i) => i !== index
            );

            // Save the updated templates array
            piper.save({
              templates: JSON.stringify(currentTemplates.value, null, 2),
            });
          };

          // Update weight of a template
          const updateWeight = (index, value) => {
            const weight = parseFloat(value);
            console.log(`Updating template ${index} weight to:`, weight);

            // Update the weight in the array
            currentTemplates.value = currentTemplates.value.map(
              (template, i) =>
                i === index ? { ...template, weight } : template
            );

            // Save the updated templates array
            piper.save({
              templates: JSON.stringify(currentTemplates.value, null, 2),
            });
          };

          // Fetch templates on mount
          onMounted(() => {
            console.log("Component mounted");
            fetchTemplates();
          });

          return {
            templates,
            currentTemplates,
            loading,
            loadingMore,
            error,
            hasMore,
            searchQuery,
            handleSearch,
            loadMore,
            selectTemplate,
            removeTemplate,
            updateWeight,
          };
        },
      });

      console.log("Creating app...");
      const app = createApp(App);
      console.log("Mounting app...");
      app.mount(piper.appRoot.querySelector("#app"));
      console.log("App mounted");
    </script>
  </body>
</html>
