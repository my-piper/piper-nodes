name: Image nodes
version: 1
tags:
  - package
readme: |-
  # Models

  ## Stability AI
  - [x] Stable Diffusion 3.5 | `text-to-image`, `image-to-image`

  ## Recraft
  - [x] Recraft V3 | `text-to-image`, `image-to-image`
  - [x] Recraft V3 SVG | `text-to-image`, `image-to-image`, `svg`
  - [x] Recraft Vectorize | `text-to-image`, `image-to-image`, `svg`

  ## Qwen / Alibaba
  - [x] Qwen Image | `text-to-image`, `image-to-image`

  ## Google
  - [ ] Google Nano Banana | `image-to-image`
  - [ ] Google Nano Banana Pro | `image-to-image`
  - [ ] Google Imagen 4 | `image-to-image`

  ## Tencent (Hunyuan)
  - [x] Hunyuan Image | `image-to-image`

  ## Luma
  - [ ] Luma Photon | `text-to-image`, `image-to-image`

  ## Minimax
  - [ ] Minimax Image 1 | `text-to-image`, `image-to-image`

  ## Runway
  - [ ] Runway Gen4 Image | `text-to-image`, `image-to-image`

  ## Ideogram
  - [x] Ideogram V3 | `text-to-image`, `image-to-image`
  - [ ] Ideogram V3 Character | `text-to-image`, `image-to-image`

  ## Black Forest Labs
  - [ ] FLUX Kontext | `text-to-image`, `image-to-image`

  ## Bytedance
  - [ ] Seedream | `text-to-image`, `image-to-image`
  - [ ] Seededit 3 | `text-to-image`, `image-to-image`

  ## Pruna AI
  - [x] Z-Image Turbo | `text-to-image`, `image-to-image`

  # Checklist

  * [ ] Node thumnail
  * [ ] Node i18: title, description, inputs/outputs, enums
  * [ ] Featured inputs/outputs
  * [ ] Default inputs values
    * [ ] See by default must be -1
    * [ ] Default prompt
  * [ ] Download all results
  * [ ] Dynamic inputs
layout:
  left: 0
  top: 0
  zoom: 0.6708695089817049
start:
  nodes: []
deploy:
  slug: test_replicate_v1
  scope:
    id: test_replicate
    activated: false
    maxConcurrent: 1
inputs:
  image:
    title: Input Image
    description: Image to edit
    type: image
    required: true
    flows:
      to_seededit_3_image_e046d:
        to: seededit_3
        input: image
      to_recraft_vectorize_image_f9847:
        to: recraft_vectorize
        input: image
      to_flux_kontext_image_32cd1:
        to: flux_kontext
        input: image
    arrange:
      x: 460
      y: 882.5
  images:
    title: Images
    description: Reference images (up to 3, aspect ratio 0.5-2). Use with tags to reference in prompt
    type: image[]
    max: 3
    flows:
      to_qwen_image_images_9900f:
        to: qwen_image
        input: images
      to_runway_gen4_image_images_b0d05:
        to: runway_gen4_image
        input: images
      to_nano_banana_images_493fd:
        to: nano_banana
        input: images
      to_nano_banana_pro_images_67111:
        to: nano_banana_pro
        input: images
    arrange:
      x: 450
      y: 1212.5
outputs: {}
flows: {}
nodes:
  recraft_v3:
    version: 0
    icon: image
    order: 105
    title: Recraft V3
    thumbnail: https://huggingface.co/PiperMy/Pipelines/resolve/main/assets/logos/replicate_logo.svg
    tags:
      - text-to-image
    execution: regular
    script: |
      export async function costs({ env }) {
        if (env.scope.REPLICATE_TOKEN === "user") {
          return 0;
        }
        return { costs: 0.04, details: "en=Price is fixed;ru=Цена фиксированна" };
      }

      const CHECK_INTERVAL = 1000;
      const MAX_RETRIES = 20;

      function catchError(error) {
        const { throwError } = require("@piper/node");

        const errorData = error.response?.data;
        const message =
          errorData?.detail || errorData?.error || error.message || error;
        if (message?.includes("E005") || message?.includes("sensitive")) {
          throwError.fatal(
            "Content flagged as sensitive. Please try different prompt.",
          );
        }

        throwError.fatal(message);
      }

      export async function run({ env, inputs, state }) {
        const {
          repeat,
          next,
          throwError,
          httpRequest,
          download,
        } = require("@piper/node");

        const { REPLICATE_TOKEN } = env.variables;
        if (!REPLICATE_TOKEN) {
          throwError.fatal("Please, set your API token for Replicate AI");
        }

        const { prompt, style, aspect_ratio, image_size } = inputs;

        if (!state) {
          const payload = {
            prompt,
            size: image_size,
            style,
            aspect_ratio,
          };

          console.log(JSON.stringify(payload, null, 2));

          try {
            const {
              data: { id: task },
            } = await httpRequest({
              method: "post",
              url: "https://api.replicate.com/v1/models/recraft-ai/recraft-v3/predictions",
              data: {
                input: payload,
              },
              headers: {
                Authorization: `Bearer ${REPLICATE_TOKEN}`,
                "Content-Type": "application/json",
              },
            });

            return repeat({
              state: { task, retries: 0 },
              delay: CHECK_INTERVAL,
            });
          } catch (e) {
            catchError(e);
          }
        } else {
          const { task, retries = 0 } = state;

          try {
            const { data } = await httpRequest({
              method: "get",
              url: `https://api.replicate.com/v1/predictions/${task}`,
              headers: {
                Authorization: `Bearer ${REPLICATE_TOKEN}`,
                "Content-Type": "application/json",
              },
            });

            const { status, error, output } = data;

            switch (status) {
              case "starting":
              case "processing":
                if (retries >= MAX_RETRIES) {
                  throwError.fatal("Generation timeout exceeded");
                }
                return repeat({
                  state: { task, retries: retries + 1 },
                  progress: {
                    total: MAX_RETRIES,
                    processed: retries,
                  },
                  delay: CHECK_INTERVAL,
                });

              case "failed":
              case "canceled":
                catchError(error);
              case "succeeded":
                const { data: image } = await download(output);
                return next({
                  outputs: { image },
                  costs: await costs({ env, inputs }),
                });
              default:
                throwError.fatal(`Unknown status: ${status}`);
            }
          } catch (e) {
            catchError(e);
          }
        }
      }
    app: ""
    sign: b555b7577e62235faece1741810f5f4b8e57c2cc8395d35d5b08630858bbbe11
    arrange:
      x: 750
      y: 140
    groups:
      inputs: {}
    inputs:
      prompt:
        order: 1
        title: en=Prompt;ru=Промпт
        description: en=Text prompt for image generation;ru=Текстовая подсказка для генерации изображения;de=Texteingabe für die Bildgenerierung;fr=Invite texte pour la génération d'image;es=Texto descriptivo para la generación de imagen;zh=用于生成图片的文本提示
        type: string
        required: true
        featured: true
        multiline: true
        default: cat astronaut walking at a moon
      aspect_ratio:
        order: 3
        title: en=Aspect Ratio;ru=Соотношение сторон
        description: en=Aspect ratio (overrides size if set);ru=Соотношение сторон (если выбрано, переопределяет размер);de=Seitenverhältnis (setzt Größe außer Kraft, falls ausgewählt);fr=Rapport d’aspect (remplace la taille si défini);es=Relación de aspecto (anula el tamaño si se establece);zh=宽高比（如设置，将覆盖尺寸）
        type: string
        default: Not set
        enum:
          - Not set|en=Not set;ru=Не задано
          - 1:1
          - 4:3
          - 3:4
          - 3:2
          - 2:3
          - 16:9
          - 9:16
          - 1:2
          - 2:1
          - 7:5
          - 5:7
          - 4:5
          - 5:4
          - 3:5
          - 5:3
      style:
        order: 4
        title: en=Style;ru=Стиль;de=Stil;fr=Style;es=Estilo;zh=风格
        description: en=Style of the generated image;ru=Стиль генерируемого изображения;de=Stil des generierten Bildes;fr=Style de l'image générée;es=Estilo de la imagen generada;zh=生成图像的风格
        type: string
        default: any
        enum:
          - any|en=Any;ru=Любой;de=Beliebig;fr=Tout;es=Cualquiera;zh=任意
          - realistic_image|en=Realistic image;ru=Реалистичное изображение;de=Realistisches Bild;fr=Image réaliste;es=Imagen realista;zh=写实图像
          - digital_illustration|en=Digital illustration;ru=Цифровая иллюстрация;de=Digitale Illustration;fr=Illustration numérique;es=Ilustración digital;zh=数字插画
          - digital_illustration/pixel_art|en=Pixel art;ru=Пиксель-арт;de=Pixelkunst;fr=Pixel art;es=Pixel art;zh=像素艺术
          - digital_illustration/hand_drawn|en=Hand drawn;ru=Рисованный от руки;de=Handgezeichnet;fr=Dessin à la main;es=Dibujado a mano;zh=手绘
          - digital_illustration/grain|en=Grain illustration;ru=Зернистая иллюстрация;de=Körnige Illustration;fr=Illustration granuleuse;es=Ilustración de grano;zh=颗粒插画
          - digital_illustration/infantile_sketch|en=Infantile sketch;ru=Детский набросок;de=Kinderskizze;fr=Esquisse enfantine;es=Boceto infantil;zh=儿童素描
          - digital_illustration/2d_art_poster|en=2D art poster;ru=2D постер;de=2D Kunstplakat;fr=Affiche d'art 2D;es=Cartel de arte 2D;zh=二维艺术海报
          - digital_illustration/handmade_3d|en=Handmade 3D;ru=Ручная 3D;de=Handgemachtes 3D;fr=3D fait main;es=3D hecho a mano;zh=手工3D
          - digital_illustration/hand_drawn_outline|en=Hand-drawn outline;ru=Ручной контур;de=Handgezeichnete Kontur;fr=Contour dessiné main;es=Contorno a mano;zh=手绘轮廓
          - digital_illustration/engraving_color|en=Color engraving;ru=Цветная гравюра;de=Farbgravur;fr=Gravure en couleur;es=Grabado en color;zh=彩色蚀刻
          - digital_illustration/2d_art_poster_2|en=2D art poster 2;ru=2D постер 2;de=2D Kunstplakat 2;fr=Affiche d'art 2D n°2;es=Cartel de arte 2D 2;zh=二维艺术海报2
          - realistic_image/b_and_w|en=Black & white;ru=Чёрно-белый;de=Schwarzweiß;fr=Noir et blanc;es=Blanco y negro;zh=黑白
          - realistic_image/hard_flash|en=Hard flash;ru=Жёсткий свет вспышки;de=Harter Blitz;fr=Flash dur;es=Flash duro;zh=强烈闪光
          - realistic_image/hdr|en=HDR;ru=HDR;de=HDR;fr=HDR;es=HDR;zh=HDR
          - realistic_image/natural_light|en=Natural light;ru=Естественный свет;de=Natürliches Licht;fr=Lumière naturelle;es=Luz natural;zh=自然光
          - realistic_image/studio_portrait|en=Studio portrait;ru=Студийный портрет;de=Studio-Porträt;fr=Portrait studio;es=Retrato de estudio;zh=工作室肖像
          - realistic_image/enterprise|en=Enterprise style;ru=Деловой стиль;de=Unternehmensstil;fr=Style entreprise;es=Estilo empresarial;zh=企业风格
          - realistic_image/motion_blur|en=Motion blur;ru=Размытие в движении;de=Bewegungsunschärfe;fr=Flou de mouvement;es=Desenfoque de movimiento;zh=运动模糊
      image_size:
        order: 2
        title: en=Size;ru=Размер
        type: string
        default: 1024x1024
        enum:
          - 1024x1024 <en=Square;ru=Квадрат>
          - 1365x1024 <en=Horizontal;ru=Горизонтальный>
          - 1024x1365 <en=Vertical;ru=Вертикальный>
          - 1536x1024 <en=Horizontal;ru=Горизонтальный>
          - 1024x1536 <en=Vertical;ru=Вертикальный>
          - 1820x1024 <en=Horizontal;ru=Горизонтальный>
          - 1024x1820 <en=Vertical;ru=Вертикальный>
          - 1024x2048 <en=Vertical;ru=Вертикальный>
          - 2048x1024 <en=Horizontal;ru=Горизонтальный>
          - 1434x1024 <en=Horizontal;ru=Горизонтальный>
          - 1024x1434 <en=Vertical;ru=Вертикальный>
          - 1024x1280 <en=Vertical;ru=Вертикальный>
          - 1280x1024 <en=Horizontal;ru=Горизонтальный>
          - 1024x1707 <en=Vertical;ru=Вертикальный>
          - 1707x1024 <en=Horizontal;ru=Горизонтальный>
    outputs:
      image:
        title: en=Image;ru=Изображение
        type: image
        featured: true
    catalog:
      _id: recraft_v3_replicate
      version: 15
      category:
        _id: generate_images
        title: en=Generate Images;ru=Ген. изображений
        icon: image
        order: 5
      package: replicate
    environment:
      REPLICATE_TOKEN:
        title: Replicate Token
        description: Go to [Replicate](https://replicate.com/account/api-tokens) to take a keys
        type: string
        scope: global
  sd_3_5:
    version: 0
    icon: image
    order: 100
    title: Stable Diffusion 3.5
    thumbnail: https://huggingface.co/PiperMy/Pipelines/resolve/main/assets/logos/replicate_logo.svg
    tags:
      - text-to-image
      - image-to-image
    execution: regular
    script: |
      export async function costs({ env, inputs }) {
        if (env.scope.REPLICATE_TOKEN === "user") {
          return 0;
        }

        const { model = "medium" } = inputs;
        switch (model) {
          case "large":
            return 0.065;
          case "medium":
          default:
            return 0.035;
        }
      }

      const CHECK_INTERVAL = 1000;
      const MAX_RETRIES = 20;

      const MODEL_PATHS = {
        medium: "stability-ai/stable-diffusion-3.5-medium",
        large: "stability-ai/stable-diffusion-3.5-large",
      };

      function catchError(error) {
        const { throwError } = require("@piper/node");

        const errorData = error.response?.data;
        const message =
          errorData?.detail || errorData?.error || error.message || error;
        if (message?.includes("E005") || message?.includes("sensitive")) {
          throwError.fatal(
            "Content flagged as sensitive. Please try different prompt.",
          );
        }

        throwError.fatal(message);
      }

      export async function run({ env, inputs, state }) {
        const {
          repeat,
          next,
          throwError,
          httpRequest,
          download,
        } = require("@piper/node");

        const { REPLICATE_TOKEN } = env.variables;
        if (!REPLICATE_TOKEN) {
          throwError.fatal("Please, set your API token for Replicate AI");
        }

        const {
          model = "medium",
          prompt,
          aspect_ratio,
          cfg,
          negative_prompt,
          seed,
          image,
          prompt_strength,
          output_format,
        } = inputs;

        if (!state) {
          const payload = {
            prompt,
            aspect_ratio,
            cfg,
            negative_prompt,
            seed,
            image,
            prompt_strength,
            output_format,
          };

          console.log(JSON.stringify(payload, null, 2));

          try {
            const {
              data: { id: task },
            } = await httpRequest({
              method: "post",
              url: `https://api.replicate.com/v1/models/${MODEL_PATHS[model]}/predictions`,
              data: {
                input: payload,
              },
              headers: {
                Authorization: `Bearer ${REPLICATE_TOKEN}`,
                "Content-Type": "application/json",
              },
            });

            return repeat({
              state: { task, retries: 0 },
              delay: CHECK_INTERVAL,
            });
          } catch (e) {
            catchError(e);
          }
        } else {
          const { task, retries = 0 } = state;

          try {
            const { data } = await httpRequest({
              method: "get",
              url: `https://api.replicate.com/v1/predictions/${task}`,
              headers: {
                Authorization: `Bearer ${REPLICATE_TOKEN}`,
                "Content-Type": "application/json",
              },
            });

            const { status, error, output } = data;

            switch (status) {
              case "starting":
              case "processing":
                if (retries >= MAX_RETRIES) {
                  throwError.fatal("Generation timeout exceeded");
                }
                return repeat({
                  state: { task, retries: retries + 1 },
                  progress: {
                    total: MAX_RETRIES,
                    processed: retries,
                  },
                  delay: CHECK_INTERVAL,
                });

              case "failed":
              case "canceled":
                catchError(error);
              case "succeeded":
                const { data: image } = await download(output);
                return next({
                  outputs: { image },
                  costs: await costs({ env, inputs }),
                });
              default:
                throwError.fatal(`Unknown status: ${status}`);
            }
          } catch (e) {
            catchError(e);
          }
        }
      }
    sign: fe954b498552d8416af7f6e1a72df4c1b7f82b63ad14fa3183ddd71d645d95c3
    arrange:
      x: 270
      y: 200
    groups:
      inputs: {}
    inputs:
      prompt:
        order: 2
        title: en=Prompt;ru=Промпт
        description: en=Text prompt for image generation;ru=Текстовая подсказка для генерации изображения
        type: string
        required: true
        featured: true
        multiline: true
        default: cat astronaut walking at a moon
      model:
        order: 1
        title: en=Model;ru=Модель
        description: en=Choose between SD 3.5 models;ru=Выберите модель SD 3.5
        type: string
        default: medium
        enum:
          - medium|en=Medium;ru=Средняя
          - large|en=Large;ru=Большая
      aspect_ratio:
        order: 3
        title: en=Aspect Ratio;ru=Соотношение сторон
        description: en=Output aspect ratio (ignored if input image is provided);ru=Соотношение сторон (игнорируется если предоставлено изображение)
        type: string
        default: 1:1
        enum:
          - 1:1|en=1:1 <en=Square;ru=Квадрат>;ru=1:1
          - 3:2|en=3:2 <en=Horizontal;ru=Горизонтальное>;ru=3:2
          - 5:4|en=5:4 <en=Horizontal;ru=Горизонтальное>;ru=5:4
          - 16:9|en=16:9 <en=Horizontal;ru=Горизонтальное>;ru=16:9
          - 21:9|en=21:9 <en=Horizontal;ru=Горизонтальное>;ru=21:9
          - 9:16|en=9:16 <en=Vertical;ru=Вертикальное>;ru=9:16
          - 9:21|en=9:21 <en=Vertical;ru=Вертикальное>;ru=9:21
          - 2:3|en=2:3 <en=Vertical;ru=Вертикальное>;ru=2:3
          - 4:5|en=4:5 <en=Vertical;ru=Вертикальное>;ru=4:5
      cfg:
        order: 4
        title: en=CFG Scale;ru=CFG шкала
        description: en=Guidance scale - how similar output should be to prompt (1-10);ru=Шкала соответствия - насколько результат должен быть похож на подсказку (1-10)
        type: float
        min: 1
        max: 10
        step: 0.5
        default: 5
      negative_prompt:
        order: 5
        title: en=Negative Prompt;ru=Негативная подсказка
        description: en=What you do not want to see in the image;ru=То, что вы не хотите видеть на изображении
        type: string
        multiline: true
      seed:
        order: 6
        title: en=Seed;ru=Начальный шум
        description: en=Random seed for reproducible generation (leave empty for random);ru=Случайное число для воспроизводимости (оставьте пустым для случайного)
        type: integer
        min: 0
        max: 2147483647
        default: -1
      image:
        order: 7
        title: en=Image;ru=Изображение
        description: en=Image for img2img mode (output will match this aspect ratio);ru=Изображение для режима img2img (выход будет с таким же соотношением сторон)
        type: image
        featured: true
      prompt_strength:
        order: 8
        title: en=Prompt Strength;ru=Сила подсказки
        description: en=Denoising strength for img2img (0-1). 1.0 = full destruction of input;ru=Степень изменения для img2img (0-1). 1.0 = полное разрушение исходного изображения
        type: float
        min: 0
        max: 1
        step: 0.05
        default: 0.85
      output_format:
        order: 9
        title: en=Output Format;ru=Формат вывода
        description: en=Format of the output image;ru=Формат итогового изображения
        type: string
        default: webp
        enum:
          - webp
          - jpg
          - png
    outputs:
      image:
        title: en=Image;ru=Изображение
        type: image
        featured: true
    catalog:
      _id: sd_35_replicate
      version: 15
      category:
        _id: generate_images
        title: en=Generate Images;ru=Ген. изображений
        icon: image
        order: 5
      package: replicate
    environment:
      REPLICATE_TOKEN:
        title: Replicate Token
        description: Go to [Replicate](https://replicate.com/account/api-tokens) to take a keys
        type: string
        scope: global
  hunyuan_Image:
    version: 0
    title: Hunyuan Image
    thumbnail: https://huggingface.co/PiperMy/Pipelines/resolve/main/assets/logos/replicate_logo.svg
    tags:
      - text-to-image
    execution: regular
    script: |
      export async function costs({ env, inputs }) {
        if (env.scope.REPLICATE_TOKEN === "user") {
          return 0;
        }
        const { model = "hunyuan-2.1" } = inputs;
        switch (model) {
          case "hunyuan-3":
            return 0.08;
          case "hunyuan-2.1":
          default:
            return 0.02;
        }
      }
      const CHECK_INTERVAL = 1000;
      const MAX_RETRIES = 40;
      const MODEL_PATHS = {
        "hunyuan-2.1": "tencent/hunyuan-image-2.1",
        "hunyuan-3": "tencent/hunyuan-image-3",
      };

      function catchError(error) {
        const { throwError } = require("@piper/node");

        const errorData = error.response?.data;
        const message =
          errorData?.detail || errorData?.error || error.message || error;
        if (message?.includes("E005") || message?.includes("sensitive")) {
          throwError.fatal(
            "Content flagged as sensitive. Please try different prompt.",
          );
        }

        throwError.fatal(message);
      }

      export async function run({ env, inputs, state }) {
        const {
          repeat,
          next,
          throwError,
          httpRequest,
          download,
        } = require("@piper/node");
        const { REPLICATE_TOKEN } = env.variables;
        if (!REPLICATE_TOKEN) {
          throwError.fatal("Please, set your API token for Replicate AI");
        }
        const {
          model = "hunyuan-2.1",
          prompt,
          aspect_ratio,
          seed,
          go_fast,
          output_format,
          output_quality,
          disable_safety_checker,
        } = inputs;
        if (!state) {
          const payload = {
            prompt,
            aspect_ratio,
            seed,
            go_fast,
            output_format,
            output_quality,
            disable_safety_checker,
          };

          console.log(JSON.stringify(payload, null, 2));

          try {
            const {
              data: { id: task },
            } = await httpRequest({
              method: "post",
              url: `https://api.replicate.com/v1/models/${MODEL_PATHS[model]}/predictions`,
              data: {
                input: payload,
              },
              headers: {
                Authorization: `Bearer ${REPLICATE_TOKEN}`,
                "Content-Type": "application/json",
              },
            });

            return repeat({
              state: {
                task,
                retries: 0,
              },
              delay: CHECK_INTERVAL,
            });
          } catch (e) {
            catchError(e);
          }
        } else {
          const { task, retries = 0 } = state;
          try {
            const { data } = await httpRequest({
              method: "get",
              url: `https://api.replicate.com/v1/predictions/${task}`,
              headers: {
                Authorization: `Bearer ${REPLICATE_TOKEN}`,
                "Content-Type": "application/json",
              },
            });
            const { status, error, output } = data;
            switch (status) {
              case "starting":
              case "processing":
                if (retries >= MAX_RETRIES) {
                  throwError.fatal("Generation timeout exceeded");
                }
                return repeat({
                  state: {
                    task,
                    retries: retries + 1,
                  },
                  progress: {
                    total: MAX_RETRIES,
                    processed: retries,
                  },
                  delay: CHECK_INTERVAL,
                });
              case "failed":
              case "canceled":
                catchError(error);
              case "succeeded": {
                const [url] = output;
                const { data: image } = await download(url);
                return next({
                  outputs: {
                    image,
                  },
                  costs: await costs({
                    env,
                    inputs,
                  }),
                });
              }
              default:
                throwError.fatal(`Unknown status: ${status}`);
            }
          } catch (e) {
            catchError(e);
          }
        }
      }
    app: ""
    sign: 2fe0e883f44029986862f4b53d68acd092a52cafb8a75ecb78e811fb3eeb1b81
    arrange:
      x: 1220
      y: 160
    groups:
      inputs: {}
    inputs:
      prompt:
        order: 2
        title: en=Prompt;ru=Промпт
        description: en=Text prompt for image generation;ru=Текстовая подсказка для генерации изображения
        type: string
        required: true
        featured: true
        multiline: true
        default: cat astronaut walking at a moon
      model:
        order: 1
        title: en=Model;ru=Модель
        description: en=Choose between Hunyuan Image versions;ru=Выберите версию Hunyuan Image
        type: string
        default: hunyuan-2.1
        enum:
          - hunyuan-2.1|en=Hunyuan 2.1;ru=Hunyuan 2.1
          - hunyuan-3|en=Hunyuan 3;ru=Hunyuan 3
      aspect_ratio:
        order: 3
        title: en=Aspect Ratio;ru=Соотношение сторон
        description: en=Aspect ratio for the generated image;ru=Соотношение сторон для генерируемого изображения
        type: string
        default: 1:1
        enum:
          - 1:1|en=1:1 (square);ru=1:1 (квадрат)
          - 16:9|en=16:9 (wide);ru=16:9 (широкий)
          - 9:16|en=9:16 (vertical);ru=9:16 (вертикальный)
          - 4:3|en=4:3 (album);ru=4:3 (альбом)
          - 3:4|en=3:4 (portrait);ru=3:4 (портрет)
          - 3:2|en=3:2 (album);ru=3:2 (альбом)
          - 2:3|en=2:3 (portrait);ru=2:3 (портрет)
      seed:
        order: 4
        title: en=Seed;ru=Начальный шум
        description: en=Random seed for reproducible generation (leave empty for random);ru=Случайное число для воспроизводимости (оставьте пустым для случайного)
        type: integer
        min: 0
        max: 2147483647
        default: -1
      go_fast:
        order: 5
        title: en=Go Fast;ru=Быстрый режим
        description: en=Run faster predictions with additional optimizations;ru=Быстрое выполнение с дополнительными оптимизациями
        type: boolean
        default: true
      output_format:
        order: 6
        title: en=Output Format;ru=Формат вывода
        description: en=Format of the output images;ru=Формат результирующих изображений
        type: string
        default: webp
        enum:
          - webp|en=WebP;ru=WebP
          - jpg|en=JPG;ru=JPG
          - png|en=PNG;ru=PNG
      output_quality:
        order: 7
        title: en=Output Quality;ru=Качество вывода
        description: en=Output image quality when saving images (0-100, not relevant for PNG);ru=Качество итоговых изображений при сохранении (0-100, не актуально для PNG)
        type: integer
        min: 0
        max: 100
        step: 1
        default: 95
      disable_safety_checker:
        order: 8
        title: en=Disable Safety Checker;ru=Откл. проверку безоп.
        description: en=Disable safety checker for generated images;ru=Отключить фильтрацию безопасности для генерируемых изображений
        type: boolean
        default: false
    outputs:
      image:
        title: en=Image;ru=Изображение
        type: image
        featured: true
    catalog:
      _id: hunyuan_image_replicate
      version: 15
      category:
        _id: generate_images
        title: en=Generate Images;ru=Ген. изображений
        icon: image
        order: 5
      package: replicate
    environment:
      REPLICATE_TOKEN:
        title: Replicate Token
        description: Go to [Replicate](https://replicate.com/account/api-tokens) to take a keys
        type: string
        scope: global
  ideogram_v3:
    version: 0
    title: Ideogram V3
    thumbnail: https://huggingface.co/PiperMy/Pipelines/resolve/main/assets/logos/replicate_logo.svg
    tags:
      - text-to-image
      - image-to-image
    execution: regular
    script: |
      export async function costs({ env, inputs }) {
        if (env.scope.REPLICATE_TOKEN === "user") {
          return 0;
        }

        const { model = "turbo" } = inputs;
        switch (model) {
          case "balanced":
            return 0.06;
          case "quality":
            return 0.09;
          case "turbo":
          default:
            return 0.03;
        }
      }

      const CHECK_INTERVAL = 1000;
      const MAX_RETRIES = 60;

      const MODEL_PATHS = {
        turbo: "ideogram-ai/ideogram-v3-turbo",
        balanced: "ideogram-ai/ideogram-v3-balanced",
        quality: "ideogram-ai/ideogram-v3-quality",
      };

      function catchError(error) {
        const { throwError } = require("@piper/node");

        const errorData = error.response?.data;
        const message =
          errorData?.detail || errorData?.error || error.message || error;
        if (message?.includes("E005") || message?.includes("sensitive")) {
          throwError.fatal(
            "Content flagged as sensitive. Please try different prompt.",
          );
        }

        throwError.fatal(message);
      }

      export async function run({ env, inputs, state }) {
        const {
          repeat,
          next,
          throwError,
          httpRequest,
          download,
        } = require("@piper/node");

        const { REPLICATE_TOKEN } = env.variables;
        if (!REPLICATE_TOKEN) {
          throwError.fatal("Please, set your API token for Replicate AI");
        }

        const {
          model = "turbo",
          prompt,
          aspect_ratio,
          resolution,
          style_type,
          style_preset,
          seed,
          style_reference_images,
        } = inputs;

        if (!state) {
          const payload = {
            prompt,
            aspect_ratio,
            resolution,
            style_type,
            style_preset,
            seed,
            style_reference_images,
          };

          console.log(JSON.stringify(payload, null, 2));

          try {
            const {
              data: { id: task },
            } = await httpRequest({
              method: "post",
              url: `https://api.replicate.com/v1/models/${MODEL_PATHS[model]}/predictions`,
              data: {
                input: payload,
              },
              headers: {
                Authorization: `Bearer ${REPLICATE_TOKEN}`,
                "Content-Type": "application/json",
              },
            });

            return repeat({
              state: { task },
              delay: CHECK_INTERVAL,
            });
          } catch (e) {
            catchError(e);
          }
        } else {
          const { task, retries = 0 } = state;

          try {
            const { data } = await httpRequest({
              method: "get",
              url: `https://api.replicate.com/v1/predictions/${task}`,
              headers: {
                Authorization: `Bearer ${REPLICATE_TOKEN}`,
                "Content-Type": "application/json",
              },
            });

            const { status, error, output } = data;

            switch (status) {
              case "starting":
              case "processing":
                if (retries >= MAX_RETRIES) {
                  throwError.fatal("Generation timeout exceeded");
                }
                return repeat({
                  state: { task, retries: retries + 1 },
                  progress: {
                    total: MAX_RETRIES,
                    processed: retries,
                  },
                  delay: CHECK_INTERVAL,
                });

              case "failed":
              case "canceled":
                catchError(error);
              case "succeeded": {
                const { data: image } = await download(output);
                return next({
                  outputs: { image },
                  costs: await costs({ env, inputs }),
                });
              }

              default:
                throwError.fatal(`Unknown status: ${status}`);
            }
          } catch (e) {
            catchError(e);
          }
        }
      }
    sign: 4730922eb2693f41afe0418713d734d1117609538f802b34e2aae12042d5567c
    arrange:
      x: 1650
      y: 180
    groups:
      inputs: {}
    inputs:
      prompt:
        order: 2
        title: en=Prompt;ru=Промпт
        description: en=Text prompt for image generation;ru=Текстовая подсказка для генерации изображения
        type: string
        required: true
        featured: true
        multiline: true
        default: cat astronaut walking at a moon
      model:
        order: 1
        title: en=Model;ru=Модель
        description: en=Choose between Ideogram V3 models;ru=Выберите модель Ideogram V3
        type: string
        default: turbo
        enum:
          - turbo|en=Turbo;ru=Турбо
          - balanced|en=Balanced;ru=Сбалансированный
          - quality|en=Quality;ru=Качество
      aspect_ratio:
        order: 3
        title: en=Aspect Ratio;ru=Соотношение сторон
        description: en=Aspect ratio (ignored if resolution or inpainting image is set);ru=Соотношение сторон (игнорируется если задано разрешение или выбран режим inpainting)
        type: string
        default: 1:1
        enum:
          - 1:3|en=1:3;ru=1:3
          - 3:1|en=3:1;ru=3:1
          - 1:2|en=1:2;ru=1:2
          - 2:1|en=2:1;ru=2:1
          - 9:16|en=9:16;ru=9:16
          - 16:9|en=16:9;ru=16:9
          - 10:16|en=10:16;ru=10:16
          - 16:10|en=16:10;ru=16:10
          - 2:3|en=2:3;ru=2:3
          - 3:2|en=3:2;ru=3:2
          - 3:4|en=3:4;ru=3:4
          - 4:3|en=4:3;ru=4:3
          - 4:5|en=4:5;ru=4:5
          - 5:4|en=5:4;ru=5:4
          - 1:1|en=1:1;ru=1:1
      resolution:
        order: 4
        title: en=Resolution;ru=Разрешение
        description: en=Specific resolution (overrides aspect ratio, ignored for inpainting);ru=Определённое разрешение (заменяет соотношение сторон, игнорируется при inpainting)
        type: string
        default: None
        enum:
          - None|en=None;ru=Нет
          - 512x1536
          - 576x1408
          - 576x1472
          - 576x1536
          - 640x1344
          - 640x1408
          - 640x1472
          - 640x1536
          - 704x1152
          - 704x1216
          - 704x1280
          - 704x1344
          - 704x1408
          - 704x1472
          - 736x1312
          - 768x1088
          - 768x1216
          - 768x1280
          - 768x1344
          - 800x1280
          - 832x960
          - 832x1024
          - 832x1088
          - 832x1152
          - 832x1216
          - 832x1248
          - 864x1152
          - 896x960
          - 896x1024
          - 896x1088
          - 896x1120
          - 896x1152
          - 960x832
          - 960x896
          - 960x1024
          - 960x1088
          - 1024x832
          - 1024x896
          - 1024x960
          - 1024x1024
          - 1088x768
          - 1088x832
          - 1088x896
          - 1088x960
          - 1120x896
          - 1152x704
          - 1152x832
          - 1152x864
          - 1152x896
          - 1216x704
          - 1216x768
          - 1216x832
          - 1248x832
          - 1280x704
          - 1280x768
          - 1280x800
          - 1312x736
          - 1344x640
          - 1344x704
          - 1344x768
          - 1408x576
          - 1408x640
          - 1408x704
          - 1472x576
          - 1472x640
          - 1472x704
          - 1536x512
          - 1536x576
          - 1536x640
      style_type:
        order: 5
        title: en=Style Type;ru=Тип стиля
        description: en=Define the specific aesthetic of the image;ru=Укажите конкретный стиль изображения
        type: string
        default: None
        enum:
          - None|en=None;ru=Нет
          - Auto|en=Auto;ru=Авто
          - General|en=General;ru=Обычный
          - Realistic|en=Realistic;ru=Реалистичный
          - Design|en=Design;ru=Дизайн
      style_preset:
        order: 6
        title: en=Style Preset;ru=Стиль
        description: en=Apply a predefined artistic style (V3 models only);ru=Применить предопределённый стиль (только для V3)
        type: string
        default: None
        enum:
          - None|en=None;ru=Без стиля
          - 80s Illustration|en=80s Illustration;ru=Иллюстрация 80-х
          - 90s Nostalgia|en=90s Nostalgia;ru=Ностальгия 90-х
          - Abstract Organic|en=Abstract Organic;ru=Абстрактный органический
          - Analog Nostalgia|en=Analog Nostalgia;ru=Аналоговая ностальгия
          - Art Brut|en=Art Brut;ru=Брутальный арт
          - Art Deco|en=Art Deco;ru=Ар-деко
          - Art Poster|en=Art Poster;ru=Арт-постер
          - Aura|en=Aura;ru=Аура
          - Avant Garde|en=Avant Garde;ru=Авангард
          - Bauhaus|en=Bauhaus;ru=Bauhaus
          - Blueprint|en=Blueprint;ru=Чертёж
          - Blurry Motion|en=Blurry Motion;ru=Размытое движение
          - Bright Art|en=Bright Art;ru=Яркий арт
          - C4D Cartoon|en=C4D Cartoon;ru=C4D мультфильм
          - Children's Book|en=Children's Book;ru=Детская книга
          - Collage|en=Collage;ru=Коллаж
          - Coloring Book I|en=Coloring Book I;ru=Раскраска I
          - Coloring Book II|en=Coloring Book II;ru=Раскраска II
          - Cubism|en=Cubism;ru=Кубизм
          - Dark Aura|en=Dark Aura;ru=Тёмная аура
          - Doodle|en=Doodle;ru=Каляки
          - Double Exposure|en=Double Exposure;ru=Двойная экспозиция
          - Dramatic Cinema|en=Dramatic Cinema;ru=Драматичное кино
          - Editorial|en=Editorial;ru=Редакционный
          - Emotional Minimal|en=Emotional Minimal;ru=Эмоциональный минимализм
          - Ethereal Party|en=Ethereal Party;ru=Эфемерная вечеринка
          - Expired Film|en=Expired Film;ru=Просроченная пленка
          - Flat Art|en=Flat Art;ru=Плоский арт
          - Flat Vector|en=Flat Vector;ru=Векторная графика
          - Forest Reverie|en=Forest Reverie;ru=Лесное мечтание
          - Geo Minimalist|en=Geo Minimalist;ru=Гео-минимализм
          - Glass Prism|en=Glass Prism;ru=Стеклянная призма
          - Golden Hour|en=Golden Hour;ru=Золотой час
          - Graffiti I|en=Graffiti I;ru=Граффити I
          - Graffiti II|en=Graffiti II;ru=Граффити II
          - Halftone Print|en=Halftone Print;ru=Полутоно́вая печать
          - High Contrast|en=High Contrast;ru=Высокий контраст
          - Hippie Era|en=Hippie Era;ru=Эпоха хиппи
          - Iconic|en=Iconic;ru=Иконичный
          - Japandi Fusion|en=Japandi Fusion;ru=Джапанди фьюжн
          - Jazzy|en=Jazzy;ru=Джазовый
          - Long Exposure|en=Long Exposure;ru=Длинная выдержка
          - Magazine Editorial|en=Magazine Editorial;ru=Эдиториал журнала
          - Minimal Illustration|en=Minimal Illustration;ru=Минималистичная иллюстрация
          - Mixed Media|en=Mixed Media;ru=Смешанная техника
          - Monochrome|en=Monochrome;ru=Монохром
          - Nightlife|en=Nightlife;ru=Ночная жизнь
          - Oil Painting|en=Oil Painting;ru=Масляная живопись
          - Old Cartoons|en=Old Cartoons;ru=Старые мультфильмы
          - Paint Gesture|en=Paint Gesture;ru=Живописный жест
          - Pop Art|en=Pop Art;ru=Поп-арт
          - Retro Etching|en=Retro Etching;ru=Ретро-гравюра
          - Riviera Pop|en=Riviera Pop;ru=Ривьера-поп
          - Spotlight 80s|en=Spotlight 80s;ru=80-е в центре внимания
          - Stylized Red|en=Stylized Red;ru=Стилизованный красный
          - Surreal Collage|en=Surreal Collage;ru=Сюрреалистичный коллаж
          - Travel Poster|en=Travel Poster;ru=Постер путешествий
          - Vintage Geo|en=Vintage Geo;ru=Винтажная геометрия
          - Vintage Poster|en=Vintage Poster;ru=Винтажный постер
          - Watercolor|en=Watercolor;ru=Акварель
          - Weird|en=Weird;ru=Странный
          - Woodblock Print|en=Woodblock Print;ru=Ксилография
      seed:
        order: 7
        title: en=Seed;ru=Начальный шум
        description: en=Random seed for reproducible generation (leave empty for random);ru=Случайное число для воспроизводимости (оставьте пустым для случайного)
        type: integer
        min: 0
        max: 2147483647
        default: -1
      style_reference_images:
        order: 8
        title: en=Style Reference Images;ru=Референсы стиля
        description: en=Reference images for style (up to 5 images supported);ru=Изображения-референсы для стиля (до 5-ти изображений)
        type: image[]
    outputs:
      image:
        title: en=Image;ru=Изображение
        type: image
        featured: true
    catalog:
      _id: ideogram_v3_replicate
      version: 15
      category:
        _id: generate_images
        title: en=Generate Images;ru=Ген. изображений
        icon: image
        order: 5
      package: replicate
    environment:
      REPLICATE_TOKEN:
        title: Replicate Token
        description: Go to [Replicate](https://replicate.com/account/api-tokens) to take a keys
        type: string
        scope: global
  google_imagen4:
    version: 0
    title: Google Imagen 4
    thumbnail: https://huggingface.co/PiperMy/Pipelines/resolve/main/assets/logos/replicate_logo.svg
    tags:
      - text-to-image
    execution: regular
    script: |
      export async function costs({ env, inputs }) {
        if (env.scope.REPLICATE_TOKEN === "user") {
          return 0;
        }
        const { model = "imagen-4" } = inputs;
        switch (model) {
          case "imagen-4-fast":
            return 0.02;
          case "imagen-4-ultra":
            return 0.06;
          case "imagen-4":
          default:
            return 0.04;
        }
      }

      const CHECK_INTERVAL = 1000;
      const MAX_RETRIES = 40;

      const MODEL_PATHS = {
        "imagen-4-fast": "google/imagen-4-fast",
        "imagen-4": "google/imagen-4",
        "imagen-4-ultra": "google/imagen-4-ultra",
      };

      function catchError(error) {
        const { throwError } = require("@piper/node");

        const errorData = error.response?.data;
        const message =
          errorData?.detail || errorData?.error || error.message || error;
        if (message?.includes("E005") || message?.includes("sensitive")) {
          throwError.fatal(
            "Content flagged as sensitive. Please try different prompt.",
          );
        }

        throwError.fatal(message);
      }

      export async function run({ env, inputs, state }) {
        const {
          repeat,
          next,
          throwError,
          httpRequest,
          download,
        } = require("@piper/node");

        const { REPLICATE_TOKEN } = env.variables;
        if (!REPLICATE_TOKEN) {
          throwError.fatal("Please, set your API token for Replicate AI");
        }

        const {
          model = "imagen-4",
          prompt,
          aspect_ratio,
          output_format,
          safety_filter_level,
        } = inputs;

        if (!state) {
          const payload = {
            prompt,
            aspect_ratio,
            output_format,
            safety_filter_level,
          };

          console.log(JSON.stringify(payload, null, 2));

          try {
            const {
              data: { id: task },
            } = await httpRequest({
              method: "post",
              url: `https://api.replicate.com/v1/models/${MODEL_PATHS[model]}/predictions`,
              data: {
                input: payload,
              },
              headers: {
                Authorization: `Bearer ${REPLICATE_TOKEN}`,
                "Content-Type": "application/json",
              },
            });

            return repeat({
              state: { task },
              delay: CHECK_INTERVAL,
            });
          } catch (e) {
            catchError(e);
          }
        } else {
          const { task, retries = 0 } = state;

          try {
            const { data } = await httpRequest({
              method: "get",
              url: `https://api.replicate.com/v1/predictions/${task}`,
              headers: {
                Authorization: `Bearer ${REPLICATE_TOKEN}`,
                "Content-Type": "application/json",
              },
            });

            const { status, error, output } = data;

            switch (status) {
              case "starting":
              case "processing":
                if (retries >= MAX_RETRIES) {
                  throwError.fatal("Generation timeout exceeded");
                }
                return repeat({
                  state: { task, retries: retries + 1 },
                  progress: {
                    total: MAX_RETRIES,
                    processed: retries,
                  },
                  delay: CHECK_INTERVAL,
                });

              case "failed":
              case "canceled":
                catchError(error);
              case "succeeded": {
                const { data: image } = await download(output);
                return next({
                  outputs: { image },
                  costs: await costs({ env, inputs }),
                });
              }

              default:
                throwError.fatal(`Unknown status: ${status}`);
            }
          } catch (err) {
            catchError(err);
          }
        }
      }
    app: ""
    sign: 904fee276128321f00ae1ca1e2ed7a11348ec2b524794bece9e17856cdbaefee
    arrange:
      x: 2080
      y: 240
    groups:
      inputs: {}
    inputs:
      prompt:
        order: 2
        title: en=Prompt;ru=Промпт
        description: en=Text prompt for image generation;ru=Текстовая подсказка для генерации изображения
        type: string
        required: true
        featured: true
        multiline: true
        default: cat astronaut walking at a moon
      model:
        order: 1
        title: en=Model;ru=Модель
        description: en=Choose between Imagen 4 models;ru=Выберите модель Imagen 4
        type: string
        default: imagen-4
        enum:
          - imagen-4-fast|en=Imagen 4 Fast;ru=Imagen 4 Fast
          - imagen-4|en=Imagen 4;ru=Imagen 4
          - imagen-4-ultra|en=Imagen 4 Ultra;ru=Imagen 4 Ultra
      aspect_ratio:
        order: 3
        title: en=Aspect Ratio;ru=Соотношение сторон
        description: en=Aspect ratio of the generated image;ru=Соотношение сторон генерируемого изображения
        type: string
        default: 1:1
        enum:
          - 1:1|en=1:1 (square);ru=1:1 (квадрат)
          - 9:16|en=9:16 (vertical);ru=9:16 (вертикальное)
          - 16:9|en=16:9 (wide);ru=16:9 (широкий)
          - 3:4|en=3:4 (portrait);ru=3:4 (портрет)
          - 4:3|en=4:3 (album);ru=4:3 (альбом)
      safety_filter_level:
        order: 4
        title: en=Safety Filter Level;ru=Уровень фильтра контента
        description: en=Content safety filter strictness;ru=Строгость фильтра безопасности
        type: string
        default: block_only_high
        enum:
          - block_low_and_above|en=Block low and above;ru=Блокировать низкий и выше
          - block_medium_and_above|en=Block medium and above;ru=Блокировать средний и выше
          - block_only_high|en=Block only high;ru=Блокировать только высокий
      output_format:
        order: 5
        title: en=Output Format;ru=Формат вывода
        description: en=Format of the output image;ru=Формат итогового изображения
        type: string
        default: jpg
        enum:
          - jpg|en=JPG;ru=JPG
          - png|en=PNG;ru=PNG
    outputs:
      image:
        title: en=Image;ru=Изображение
        type: image
        featured: true
    catalog:
      _id: google_imagen_4_replicate
      version: 15
      category:
        _id: generate_images
        title: en=Generate Images;ru=Ген. изображений
        icon: image
        order: 5
      package: replicate
    environment:
      REPLICATE_TOKEN:
        title: Replicate Token
        description: Go to [Replicate](https://replicate.com/account/api-tokens) to take a keys
        type: string
        scope: global
  z_image_turbo:
    version: 0
    title: Z-Image Turbo
    description: Fast image generation with Z-Image Turbo model
    thumbnail: https://huggingface.co/PiperMy/Pipelines/resolve/main/assets/logos/replicate_logo.svg
    tags:
      - text-to-image
    execution: regular
    script: |
      export async function costs({ env }) {
        if (env.scope.REPLICATE_TOKEN === "user") {
          return 0;
        }
        return 0.01;
      }

      const CHECK_INTERVAL = 1000;
      const MAX_RETRIES = 30;

      function catchError(error) {
        const { throwError } = require("@piper/node");

        const errorData = error.response?.data;
        const message =
          errorData?.detail || errorData?.error || error.message || error;
        if (message?.includes("E005") || message?.includes("sensitive")) {
          throwError.fatal(
            "Content flagged as sensitive. Please try different prompt.",
          );
        }

        throwError.fatal(message);
      }

      export async function run({ env, inputs, state }) {
        const {
          repeat,
          next,
          throwError,
          httpRequest,
          download,
        } = require("@piper/node");

        const { REPLICATE_TOKEN } = env.variables;
        if (!REPLICATE_TOKEN) {
          throwError.fatal("Please, set your API token for Replicate AI");
        }

        const {
          prompt,
          width,
          height,
          num_inference_steps,
          guidance_scale,
          seed,
          output_format,
          output_quality,
        } = inputs;

        if (!state) {
          const payload = {
            prompt,
            width,
            height,
            num_inference_steps,
            guidance_scale,
            output_format,
            output_quality,
            seed,
          };

          console.log(JSON.stringify(payload, null, 2));

          try {
            const {
              data: { id: task },
            } = await httpRequest({
              method: "post",
              url: "https://api.replicate.com/v1/models/prunaai/z-image-turbo/versions/7ea16386290ff5977c7812e66e462d7ec3954d8e007a8cd18ded3e7d41f5d7cf/predictions",
              data: {
                input: payload,
              },
              headers: {
                Authorization: `Bearer ${REPLICATE_TOKEN}`,
                "Content-Type": "application/json",
              },
            });

            return repeat({
              state: { task },
              delay: CHECK_INTERVAL,
            });
          } catch (e) {
            catchError(e);
          }
        } else {
          const { task, retries = 0 } = state;

          try {
            const { data } = await httpRequest({
              method: "get",
              url: `https://api.replicate.com/v1/predictions/${task}`,
              headers: {
                Authorization: `Bearer ${REPLICATE_TOKEN}`,
                "Content-Type": "application/json",
              },
            });

            const { status, error, output } = data;

            switch (status) {
              case "starting":
              case "processing":
                if (retries >= MAX_RETRIES) {
                  throwError.fatal("Generation timeout exceeded");
                }
                return repeat({
                  state: { task, retries: retries + 1 },
                  progress: {
                    total: MAX_RETRIES,
                    processed: retries,
                  },
                  delay: CHECK_INTERVAL,
                });

              case "failed":
              case "canceled":
                catchError(error);
              case "succeeded":
                const { data: image } = await download(output);
                return next({
                  outputs: { image },
                  costs: await costs({ env, inputs }),
                });
              default:
                throwError.fatal(`Unknown status: ${status}`);
            }
          } catch (e) {
            catchError(e);
          }
        }
      }
    sign: b1dbb5c64f57d0e249b1b9eef3112f799cff03bd13ed9b08be4f23ae7a02832e
    arrange:
      x: 2490
      y: 330
    groups:
      inputs: {}
    inputs:
      prompt:
        order: 1
        title: en=Prompt;ru=Промпт
        description: en=Text prompt for image generation;ru=Текстовая подсказка для генерации изображения
        type: string
        required: true
        featured: true
        multiline: true
        default: cat astronaut walking at a moon
      seed:
        order: 6
        title: en=Seed;ru=Начальный шум
        description: en=Random seed for reproducible generation (leave empty for random);ru=Случайное число для воспроизводимости (оставьте пустым для случайного)
        type: integer
        default: -1
      height:
        order: 2
        title: en=Height;ru=Высота
        description: en=Height of the generated image in pixels (64-2048);ru=Высота изображения в пикселях (64-2048)
        type: integer
        min: 64
        max: 2048
        step: 8
        default: 1024
      width:
        order: 3
        title: en=Width;ru=Ширина
        description: en=Width of the generated image in pixels (64-2048);ru=Ширина изображения в пикселях (64-2048)
        type: integer
        min: 64
        max: 2048
        step: 8
        default: 1024
      num_inference_steps:
        order: 4
        title: en=Inference Steps;ru=Кол-во шагов
        description: en=Number of inference steps (results in steps - 1 DiT forwards);ru=Количество шагов генерации (кол-во прямых проходов DiT на 1 меньше)
        type: integer
        min: 1
        max: 50
        step: 1
        default: 8
      guidance_scale:
        order: 5
        title: en=Guidance Scale;ru=Шкала управления
        description: en=Guidance scale (should be 0 for Turbo models);ru=Степень привязки к подсказке (для Turbo должна быть 0)
        type: float
        min: 0
        max: 20
        step: 0.5
        default: 0
      output_format:
        order: 7
        title: en=Output Format;ru=Формат вывода
        description: en=Format of the output image;ru=Формат итогового изображения
        type: string
        default: jpg
        enum:
          - jpg|en=JPG;ru=JPG
          - png|en=PNG;ru=PNG
          - webp|en=WebP;ru=WebP
      output_quality:
        order: 8
        title: en=Output Quality;ru=Качество вывода
        description: en=Quality when saving the output (0-100, not relevant for PNG);ru=Качество при сохранении изображения (0-100, не влияет для PNG)
        type: integer
        min: 0
        max: 100
        default: 80
    outputs:
      image:
        title: en=Image;ru=Изображение
        type: image
        featured: true
    catalog:
      _id: z_image_turbo_replicate
      version: 15
      category:
        _id: generate_images
        title: en=Generate Images;ru=Ген. изображений
        icon: image
        order: 5
      package: replicate
    environment:
      REPLICATE_TOKEN:
        title: Replicate Token
        description: Go to [Replicate](https://replicate.com/account/api-tokens) to get your API token
        type: string
        scope: global
  recraft_v3_svg:
    version: 0
    title: Recraft V3 SVG
    thumbnail: https://huggingface.co/PiperMy/Pipelines/resolve/main/assets/logos/replicate_logo.svg
    tags:
      - text-to-image
      - svg
    execution: regular
    script: |
      export async function costs({ env }) {
        if (env.scope.REPLICATE_TOKEN === "user") {
          return 0;
        }
        return 0.08;
      }

      const CHECK_INTERVAL = 2000;
      const MAX_RETRIES = 40;

      function catchError(error) {
        const { throwError } = require("@piper/node");

        const errorData = error.response?.data;
        const message =
          errorData?.detail || errorData?.error || error.message || error;
        if (message?.includes("E005") || message?.includes("sensitive")) {
          throwError.fatal(
            "Content flagged as sensitive. Please try different prompt.",
          );
        }

        throwError.fatal(message);
      }

      export async function run({ env, inputs, state }) {
        const {
          repeat,
          next,
          throwError,
          httpRequest,
          download,
        } = require("@piper/node");

        const { REPLICATE_TOKEN } = env.variables;
        if (!REPLICATE_TOKEN) {
          throwError.fatal("Please, set your API token for Replicate AI");
        }

        const {
          prompt,
          aspect_ratio,
          size,
          style,
        } = inputs;

        if (!state) {
          const payload = {
            prompt,
            aspect_ratio,
            size,
            style,
          };

          console.log(JSON.stringify(payload, null, 2));

          try {
            const {
              data: { id: task },
            } = await httpRequest({
              method: "post",
              url: "https://api.replicate.com/v1/models/recraft-ai/recraft-v3-svg/predictions",
              data: {
                input: payload,
              },
              headers: {
                Authorization: `Bearer ${REPLICATE_TOKEN}`,
                "Content-Type": "application/json",
              },
            });

            return repeat({
              state: { task},
              delay: CHECK_INTERVAL,
            });
          } catch (err) {
            catchError(err);
          }
        } else {
          const { task, retries = 0 } = state;

          try {
            const { data } = await httpRequest({
              method: "get",
              url: `https://api.replicate.com/v1/predictions/${task}`,
              headers: {
                Authorization: `Bearer ${REPLICATE_TOKEN}`,
                "Content-Type": "application/json",
              },
            });

            const { status, error, output } = data;

            switch (status) {
              case "starting":
              case "processing":
                if (retries >= MAX_RETRIES) {
                  throwError.fatal("Generation timeout exceeded");
                }
                return repeat({
                  state: { task, retries: retries + 1 },
                  progress: {
                    total: MAX_RETRIES,
                    processed: retries,
                  },
                  delay: CHECK_INTERVAL,
                });

              case "failed":
              case "canceled":
                catchError(error);
              case "succeeded": {
                const { data: svg } = await download(output);
                return next({
                  outputs: { svg },
                  costs: await costs({ env }),
                });
              }

              default:
                throwError.fatal(`Unknown status: ${status}`);
            }
          } catch (err) {
            catchError(err);
          }
        }
      }
    sign: c222add7e4842b85e21f1c58f784b26234cc989e79445e3efc8b4ecb3819ec25
    arrange:
      x: 2870
      y: 230
    groups:
      inputs: {}
    inputs:
      prompt:
        order: 1
        title: en=Prompt;ru=Промпт
        description: en=Text prompt for SVG vector image generation;ru=Текстовый промпт для генерации векторного SVG-изображения
        type: string
        required: true
        featured: true
        multiline: true
        default: cat astronaut walking at a moon
      aspect_ratio:
        order: 2
        title: en=Aspect Ratio;ru=Соотношение сторон
        description: en=Aspect ratio (overrides size if set);ru=Соотношение сторон (переопределяет размер при установке)
        type: string
        default: Not set
        enum:
          - Not set|en=Not set;ru=Не задано
          - 1:1|en=1:1;ru=1:1
          - 4:3|en=4:3;ru=4:3
          - 3:4|en=3:4;ru=3:4
          - 3:2|en=3:2;ru=3:2
          - 2:3|en=2:3;ru=2:3
          - 16:9|en=16:9;ru=16:9
          - 9:16|en=9:16;ru=9:16
          - 1:2|en=1:2;ru=1:2
          - 2:1|en=2:1;ru=2:1
          - 7:5|en=7:5;ru=7:5
          - 5:7|en=5:7;ru=5:7
          - 4:5|en=4:5;ru=4:5
          - 5:4|en=5:4;ru=5:4
          - 3:5|en=3:5;ru=3:5
          - 5:3|en=5:3;ru=5:3
      style:
        order: 3
        title: en=Style;ru=Стиль
        description: en=SVG style of the generated image;ru=Стиль SVG для генерируемого изображения
        type: string
        default: any
        enum:
          - any|en=Any;ru=Любой
          - engraving|en=Engraving;ru=Гравюра
          - line_art|en=Line art;ru=Линейный арт
          - line_circuit|en=Line circuit;ru=Линейная схема
          - linocut|en=Linocut;ru=Линогравюра
    outputs:
      svg:
        title: en=SVG Image;ru=SVG
        type: image
        featured: true
    catalog:
      _id: recraft_v3_svg_replicate
      version: 15
      category:
        _id: generate_images
        title: en=Generate Images;ru=Ген. изображений
        icon: image
        order: 5
      package: replicate
    environment:
      REPLICATE_TOKEN:
        title: Replicate Token
        description: Go to [Replicate](https://replicate.com/account/api-tokens) to take a keys
        type: string
        scope: global
  seededit_3:
    version: 0
    title: ByteDance Seededit 3
    thumbnail: https://huggingface.co/PiperMy/Pipelines/resolve/main/assets/logos/replicate_logo.svg
    tags:
      - image-to-image
    execution: regular
    script: |
      export async function costs({ env }) {
        if (env.scope.REPLICATE_TOKEN === "user") {
          return 0;
        }
        return 0.03;
      }

      const CHECK_INTERVAL = 2000;
      const MAX_RETRIES = 40;

      function catchError(error) {
        const { throwError } = require("@piper/node");

        const errorData = error.response?.data;
        const message =
          errorData?.detail || errorData?.error || error.message || error;
        if (message?.includes("E005") || message?.includes("sensitive")) {
          throwError.fatal(
            "Content flagged as sensitive. Please try different prompt.",
          );
        }

        throwError.fatal(message);
      }

      export async function run({ env, inputs, state }) {
        const {
          repeat,
          next,
          throwError,
          httpRequest,
          download,
        } = require("@piper/node");

        const { REPLICATE_TOKEN } = env.variables;
        if (!REPLICATE_TOKEN) {
          throwError.fatal("Please, set your API token for Replicate AI");
        }

        const {
          image,
          prompt,
          seed,
          guidance_scale,
        } = inputs;

        if (!state) {
          const payload = {
            image,
            prompt,
            guidance_scale,
            seed,
          };

          console.log(JSON.stringify(payload, null, 2));

          try {
            const {
              data: { id: task },
            } = await httpRequest({
              method: "post",
              url: "https://api.replicate.com/v1/models/bytedance/seededit-3.0/predictions",
              data: {
                input: payload,
              },
              headers: {
                Authorization: `Bearer ${REPLICATE_TOKEN}`,
                "Content-Type": "application/json",
              },
            });

            return repeat({
              state: { task },
              delay: CHECK_INTERVAL,
            });
          } catch (err) {
            catchError(err);
          }
        } else {
          const { task, retries = 0 } = state;

          try {
            const { data } = await httpRequest({
              method: "get",
              url: `https://api.replicate.com/v1/predictions/${task}`,
              headers: {
                Authorization: `Bearer ${REPLICATE_TOKEN}`,
                "Content-Type": "application/json",
              },
            });

            const { status, error, output } = data;

            switch (status) {
              case "starting":
              case "processing":
                if (retries >= MAX_RETRIES) {
                  throwError.fatal("Editing timeout exceeded");
                }
                return repeat({
                  state: { task, retries: retries + 1 },
                  progress: {
                    total: MAX_RETRIES,
                    processed: retries,
                  },
                  delay: CHECK_INTERVAL,
                });
              case "failed":
              case "canceled":
                catchError(error);
              case "succeeded": {
                const { data: image } = await download(output);
                return next({
                  outputs: { image },
                  costs: await costs({ env }),
                });
              }

              default:
                throwError.fatal(`Unknown status: ${status}`);
            }
          } catch (err) {
            catchError(err);
          }
        }
      }
    sign: 84957d3b31065fe962760ad6d545ee66a622be92a99ede7f919b74604b5a250f
    arrange:
      x: 610
      y: 550
    groups:
      inputs: {}
    inputs:
      image:
        order: 1
        title: en=Image;ru=Изображение
        description: en=Image to edit;ru=Изображение для редактирования
        type: image
        required: true
        featured: true
      prompt:
        order: 2
        title: en=Prompt;ru=Промпт
        description: en=Text prompt describing the desired edits;ru=Текстовое описание желаемых изменений
        type: string
        required: true
        featured: true
        multiline: true
        default: change style to anime
      guidance_scale:
        order: 3
        title: en=Guidance scale;ru=Точность промта
        description: en=Prompt adherence (1-10). Higher values = more literal interpretation;ru=Степень следования промпту (1-10). Больше значение — более буквальная трактовка
        type: float
        min: 1
        max: 10
        step: 0.1
        default: 5.5
      seed:
        order: 4
        title: en=Seed;ru=Начальный шум
        description: en=Random seed for reproducible generation (leave empty for random);ru=Случайный шум для воспроизводимости (оставьте пустым для случайного)
        type: integer
        min: 0
        max: 2147483647
        default: -1
    outputs:
      image:
        title: en=Image;ru=Изображение
        type: image
        featured: true
    catalog:
      _id: seededit_3_replicate
      version: 15
      category:
        _id: generate_images
        title: en=Generate Images;ru=Ген. изображений
        icon: image
        order: 5
      package: replicate
    environment:
      REPLICATE_TOKEN:
        title: Replicate Token
        description: Go to [Replicate](https://replicate.com/account/api-tokens) to take a keys
        type: string
        scope: global
  recraft_vectorize:
    version: 0
    title: en=Recraft Vectorize;ru=Recraft Векторизация
    thumbnail: https://huggingface.co/PiperMy/Pipelines/resolve/main/assets/logos/replicate_logo.svg
    tags:
      - image-to-image
      - svg
    execution: regular
    script: |
      export async function costs({ env }) {
        if (env.scope.REPLICATE_TOKEN === "user") {
          return 0;
        }
        return 0.01;
      }

      const CHECK_INTERVAL = 2000;
      const MAX_RETRIES = 40;

      function catchError(error) {
        const { throwError } = require("@piper/node");

        const errorData = error.response?.data;
        const message =
          errorData?.detail || errorData?.error || error.message || error;
        if (message?.includes("E005") || message?.includes("sensitive")) {
          throwError.fatal(
            "Content flagged as sensitive. Please try different prompt.",
          );
        }

        throwError.fatal(message);
      }

      export async function run({ env, inputs, state }) {
        const {
          repeat,
          next,
          throwError,
          httpRequest,
          download,
        } = require("@piper/node");

        const { REPLICATE_TOKEN } = env.variables;
        if (!REPLICATE_TOKEN) {
          throwError.fatal("Please, set your API token for Replicate AI");
        }

        if (!state) {
          const { image } = inputs;

          const payload = { image };
          console.log(JSON.stringify(payload, null, 2));

          try {
            const {
              data: { id: task },
            } = await httpRequest({
              method: "post",
              url: "https://api.replicate.com/v1/models/recraft-ai/recraft-vectorize/predictions",
              data: {
                input: payload,
              },
              headers: {
                Authorization: `Bearer ${REPLICATE_TOKEN}`,
                "Content-Type": "application/json",
              },
            });

            return repeat({
              state: { task},
              delay: CHECK_INTERVAL,
            });
          } catch (err) {
            catchError(err);
          }
        } else {
          const { task, retries = 0 } = state;

          try {
            const { data } = await httpRequest({
              method: "get",
              url: `https://api.replicate.com/v1/predictions/${task}`,
              headers: {
                Authorization: `Bearer ${REPLICATE_TOKEN}`,
                "Content-Type": "application/json",
              },
            });

            const { status, error, output } = data;

            switch (status) {
              case "starting":
              case "processing":
                if (retries >= MAX_RETRIES) {
                  throwError.fatal("Vectorization timeout exceeded");
                }
                return repeat({
                  state: { task, retries: retries + 1 },
                  progress: {
                    total: MAX_RETRIES,
                    processed: retries,
                  },
                  delay: CHECK_INTERVAL,
                });

              case "failed":
              case "canceled":
                catchError(error);
              case "succeeded": {
                const { data: svg } = await download(output);
                return next({
                  outputs: { svg },
                  costs: await costs({ env }),
                });
              }

              default:
                throwError.fatal(`Unknown status: ${status}`);
            }
          } catch (err) {
            catchError(err);
          }
        }
      }
    app: ""
    sign: c5801f02f42d690ecc5bae26ef624470133132d2cacaec684b48340a2588f5ea
    arrange:
      x: 1030
      y: 570
    groups:
      inputs: {}
    inputs:
      image:
        order: 1
        title: en=Image;ru=Изображение
        description: en=Raster image to convert to SVG (PNG/JPG/WEBP, max 5MB, 256-4096px, max 16MP);ru=Растровое изображение для конвертации в SVG (PNG/JPG/WEBP, макс. 5МБ, 256-4096px, макс. 16МП)
        type: image
        required: true
        featured: true
    outputs:
      svg:
        title: en=SVG;ru=SVG
        type: image
        featured: true
    catalog:
      _id: recraft_vectorize_replicate
      version: 15
      category:
        _id: generate_images
        title: en=Generate Images;ru=Ген. изображений
        icon: image
        order: 5
      package: replicate
    environment:
      REPLICATE_TOKEN:
        title: Replicate Token
        description: Go to [Replicate](https://replicate.com/account/api-tokens) to take a keys
        type: string
        scope: global
  qwen_image:
    version: 0
    title: Qwen Image
    description: Generate and edit images with Qwen Image model
    thumbnail: https://huggingface.co/PiperMy/Pipelines/resolve/main/assets/logos/replicate_logo.svg
    tags:
      - text-to-image
      - image-to-image
    execution: regular
    script: |
      export async function costs({ env }) {
        if (env.scope.REPLICATE_TOKEN === "user") {
          return 0;
        }
        return 0.03;
      }

      const CHECK_INTERVAL = 2000;
      const MAX_RETRIES = 90;

      function catchError(error) {
        const { throwError } = require("@piper/node");

        const errorData = error.response?.data;
        const message =
          errorData?.detail || errorData?.error || error.message || error;
        if (message?.includes("E005") || message?.includes("sensitive")) {
          throwError.fatal(
            "Content flagged as sensitive. Please try different prompt.",
          );
        }

        throwError.fatal(message);
      }

      export async function run({ env, inputs, state }) {
        const {
          repeat,
          next,
          throwError,
          httpRequest,
          download,
        } = require("@piper/node");

        const { REPLICATE_TOKEN } = env.variables;
        if (!REPLICATE_TOKEN) {
          throwError.fatal("Please, set your API token for Replicate AI");
        }

        if (!state) {
          const {
            prompt,
            images,
            aspect_ratio,
            image_size,
            negative_prompt,
            num_inference_steps,
            guidance,
            enhance_prompt,
            seed,
            output_format,
            output_quality,
            go_fast,
            disable_safety_checker,
          } = inputs;

          let payload = {
            prompt,
            enhance_prompt,
            negative_prompt,
            aspect_ratio,
            image_size,
            guidance,
            num_inference_steps,
            output_format,
            output_quality,
            go_fast,
            disable_safety_checker,
            seed,
          };

          let model;
          if (images?.length > 0) {
            // image to image
            model = "qwen/qwen-image-edit-plus-lora";
            payload = {
              ...payload,
              image: images,
            };
          } else {
            // text to image
            model = "qwen/qwen-image";
          }

          console.log(JSON.stringify(payload, null, 2));

          try {
            const {
              data: { id: task },
            } = await httpRequest({
              method: "post",
              url: `https://api.replicate.com/v1/models/${model}/predictions`,
              data: {
                input: payload,
              },
              headers: {
                Authorization: `Bearer ${REPLICATE_TOKEN}`,
                "Content-Type": "application/json",
              },
            });

            return repeat({
              state: { task },
              delay: CHECK_INTERVAL,
            });
          } catch (err) {
            catchError(err);
          }
        } else {
          const { task, retries = 0 } = state;

          try {
            const { data } = await httpRequest({
              method: "get",
              url: `https://api.replicate.com/v1/predictions/${task}`,
              headers: {
                Authorization: `Bearer ${REPLICATE_TOKEN}`,
                "Content-Type": "application/json",
              },
            });

            const { status, error, output } = data;

            switch (status) {
              case "starting":
              case "processing":
                if (retries >= MAX_RETRIES) {
                  throwError.fatal("Generation timeout exceeded");
                }
                return repeat({
                  state: { task, retries: retries + 1 },
                  progress: {
                    total: MAX_RETRIES,
                    processed: retries,
                  },
                  delay: CHECK_INTERVAL,
                });

              case "failed":
              case "canceled":
                catchError(error);
              case "succeeded": {
                let [url] = output;
                const { data: image } = await download(url);
                return next({
                  outputs: { image },
                  costs: await costs({ env, inputs }),
                });
              }
              default:
                throwError.fatal(`Unknown status: ${status}`);
            }
          } catch (err) {
            catchError(err);
          }
        }
      }
    sign: 3a590a5e694e5a5c39edd0e49728e6140b0945b7882a4fb3c021b4ea381b698e
    arrange:
      x: 690
      y: 980
    groups:
      inputs: {}
    inputs:
      prompt:
        order: 1
        title: en=Prompt;ru=Промпт
        description: en=Text prompt for generation or editing instruction;ru=Текстовое описание к генерации или инструкции по редактированию
        type: string
        required: true
        featured: true
        multiline: true
        default: change style to anime
      seed:
        order: 8
        title: en=Seed;ru=Начальный шум
        description: en=Random seed for reproducible generation;ru=Случайный шум для воспроизводимости
        type: integer
        default: -1
      aspect_ratio:
        order: 3
        title: en=Aspect Ratio;ru=Соотношение сторон
        description: en=Aspect ratio for the generated image (edit mode uses 'match_input_image' when image provided);ru=Соотношение сторон для генерируемого изображения (в режиме редактирования используется match_input_image)
        type: string
        default: 16:9
        enum:
          - 1:1|en=1:1;ru=1:1
          - 16:9|en=16:9;ru=16:9
          - 9:16|en=9:16;ru=9:16
          - 4:3|en=4:3;ru=4:3
          - 3:4|en=3:4;ru=3:4
          - 3:2|en=3:2;ru=3:2
          - 2:3|en=2:3;ru=2:3
          - match_input_image|en=Match input image;ru=Как у исходного
      image_size:
        order: 4
        title: en=Image Size;ru=Размер изображения
        description: en=Quality vs speed optimization (only for text-to-image mode);ru=Оптимизация изображение по качеству/скорости (только для text-to-image)
        type: string
        default: optimize_for_quality
        enum:
          - optimize_for_quality|en=Quality;ru=Качество
          - optimize_for_speed|en=Speed;ru=Скорость
      num_inference_steps:
        order: 5
        title: en=Inference Steps;ru=Шаги инференса
        description: en=Number of denoising steps (1-50, only for text-to-image mode);ru=Количество шагов денойзинга (1-50, только для text-to-image)
        type: integer
        min: 1
        max: 50
        default: 30
      guidance:
        order: 6
        title: en=Guidance;ru=Точность
        description: en=Guidance scale (0-10, lower = more realistic, try 2-3.5);ru=Степень следования промпту (0-10, ниже — реалистичнее, пробуйте 2-3.5)
        type: float
        min: 0
        max: 10
        step: 0.5
        default: 3
      negative_prompt:
        order: 7
        title: en=Negative Prompt;ru=Негативный промпт
        description: en=Negative prompt for generated image (only for text-to-image mode);ru=Негативный промпт (только для text-to-image)
        type: string
        multiline: true
        default: " "
      go_fast:
        order: 9
        title: en=Go Fast;ru=Быстро
        description: en=Run faster predictions with additional optimizations;ru=Быстрое выполнение с доп. ускорениями
        type: boolean
        default: true
      enhance_prompt:
        order: 10
        title: en=Enhance Prompt;ru=Улучшить промпт
        description: en=Enhance the prompt with positive magic (only for text-to-image mode);ru=Магически улучшить промпт (только для text-to-image)
        type: boolean
        default: false
      output_format:
        order: 11
        title: en=Output Format;ru=Формат вывода
        description: en=Format of the output images;ru=Формат итоговых изображений
        type: string
        default: webp
        enum:
          - webp|en=WebP;ru=WebP
          - jpg|en=JPG;ru=JPG
          - png|en=PNG;ru=PNG
      output_quality:
        order: 12
        title: en=Output Quality;ru=Качество вывода
        description: en=Quality when saving (0-100, not relevant for PNG);ru=Качество (0-100, не актуально для PNG)
        type: integer
        min: 0
        max: 100
        default: 80
      disable_safety_checker:
        order: 13
        title: en=Disable Safety Checker;ru=Откл. проверку безоп.
        description: en=Disable safety checker for generated images;ru=Отключить фильтрацию безопасности для генерируемых изображений
        type: boolean
        default: true
      images:
        order: 2
        title: en=Images;ru=Изображения
        description: en=Input image for image-to-image mode (if provided, switches to edit mode automatically);ru=Входное изображение для режима image-to-image (если указано, переходит в режим редактирования)
        type: image[]
        featured: true
    outputs:
      image:
        title: en=Image;ru=Изображение
        type: image
        featured: true
    catalog:
      _id: qwen_image_replicate
      version: 15
      category:
        _id: generate_images
        title: en=Generate Images;ru=Ген. изображений
        icon: image
        order: 5
      package: replicate
    environment:
      REPLICATE_TOKEN:
        title: Replicate Token
        description: Go to [Replicate](https://replicate.com/account/api-tokens) to get your API token
        type: string
        scope: global
  runway_gen4_image:
    version: 0
    title: Runway Gen4 Image
    thumbnail: https://huggingface.co/PiperMy/Pipelines/resolve/main/assets/logos/replicate_logo.svg
    tags:
      - text-to-image
      - image-to-image
    execution: regular
    script: |
      export async function costs({ env, inputs }) {
        if (env.scope.REPLICATE_TOKEN === "user") {
          return 0;
        }
        const { model = "standard" } = inputs;
        switch (model) {
          case "turbo":
            return 0.05;
          case "standard":
            return 0.08;
          default:
            return 0.08;
        }
      }

      const CHECK_INTERVAL = 2000;
      const MAX_RETRIES = 50;

      const MODELS = {
        standard: "runwayml/gen4-image",
        turbo: "runwayml/gen4-image-turbo",
      };

      function catchError(error) {
        const { throwError } = require("@piper/node");

        const errorData = error.response?.data;
        const message =
          errorData?.detail || errorData?.error || error.message || error;
        if (message?.includes("E005") || message?.includes("sensitive")) {
          throwError.fatal(
            "Content flagged as sensitive. Please try different prompt.",
          );
        }

        throwError.fatal(message);
      }

      export async function run({ env, inputs, state }) {
        const {
          repeat,
          next,
          throwError,
          httpRequest,
          download,
        } = require("@piper/node");

        const { REPLICATE_TOKEN } = env.variables;
        if (!REPLICATE_TOKEN) {
          throwError.fatal("Please, set your API token for Replicate AI");
        }

        const {
          model = "standard",
          prompt,
          images,
          tags = "@cat",
          aspect_ratio,
          resolution,
          seed,
        } = inputs;

        if (!state) {
          const payload = {
            prompt,
            reference_images: images,
            ...(!!tags?.length > 0
              ? { reference_tags: [...tags.matchAll(/@(\w+)/g)].map((m) => m[1]) }
              : {}),
            aspect_ratio,
            resolution,
            seed,
          };

          console.log(JSON.stringify(payload, null, "\t"));

          try {
            const {
              data: { id: task },
            } = await httpRequest({
              method: "post",
              url: `https://api.replicate.com/v1/models/${MODELS[model]}/predictions`,
              data: {
                input: payload,
              },
              headers: {
                Authorization: `Bearer ${REPLICATE_TOKEN}`,
                "Content-Type": "application/json",
              },
            });

            return repeat({
              state: { task},
              delay: CHECK_INTERVAL,
            });
          } catch (err) {
            catchError(err);
          }
        } else {
          const { task, retries = 0 } = state;

          try {
            const { data } = await httpRequest({
              method: "get",
              url: `https://api.replicate.com/v1/predictions/${task}`,
              headers: {
                Authorization: `Bearer ${REPLICATE_TOKEN}`,
                "Content-Type": "application/json",
              },
            });

            const { status, error, output } = data;

            switch (status) {
              case "starting":
              case "processing":
                if (retries >= MAX_RETRIES) {
                  throwError.fatal("Generation timeout exceeded");
                }
                return repeat({
                  state: { task, retries: retries + 1 },
                  progress: {
                    total: MAX_RETRIES,
                    processed: retries,
                  },
                  delay: CHECK_INTERVAL,
                });

              case "failed":
              case "canceled":
                catchError(error);
              case "succeeded": {
                const { data: image } = await download(output);
                return next({
                  outputs: { image },
                  costs: await costs({ env, inputs }),
                });
              }

              default:
                throwError.fatal(`Unknown status: ${status}`);
            }
          } catch (err) {
            catchError(err);
          }
        }
      }
    app: ""
    sign: 7235c5a28691873b36020f798ea7a3272bc3dda8bf0a5f70598974a84852c41b
    arrange:
      x: 640
      y: 1350
    groups:
      inputs: {}
    inputs:
      prompt:
        order: 2
        title: en=Prompt;ru=Промпт
        description: en=Text prompt for image generation. Use @tag_name to reference images;ru=Текстовая подсказка для генерации изображения. Используйте @имя_тега для привязки к картинке
        type: string
        required: true
        featured: true
        multiline: true
        default: change style to anime for @cat
      model:
        order: 1
        title: en=Model;ru=Модель
        description: en=Choose between Gen4 Image models;ru=Выберите модель Gen4 Image
        type: string
        default: standard
        enum:
          - standard|en=Standard;ru=Стандартная
          - turbo|en=Turbo;ru=Турбо
      aspect_ratio:
        order: 5
        title: en=Aspect Ratio;ru=Соотношение сторон
        description: en=Image aspect ratio;ru=Соотношение сторон изображения
        type: string
        default: 16:9
        enum:
          - 16:9|en=16:9;ru=16:9
          - 9:16|en=9:16;ru=9:16
          - 4:3|en=4:3;ru=4:3
          - 3:4|en=3:4;ru=3:4
          - 1:1|en=1:1;ru=1:1
          - 21:9|en=21:9;ru=21:9
      resolution:
        order: 6
        title: en=Resolution;ru=Разрешение
        description: en=Image resolution;ru=Разрешение изображения
        type: string
        default: 1080p
        enum:
          - 720p|en=720p;ru=720p
          - 1080p|en=1080p;ru=1080p
      seed:
        order: 7
        title: en=Seed;ru=Начальный шум
        description: en=Random seed for reproducible generation (leave empty for random);ru=Случайный шум для воспроизводимости (оставьте пустым для случайного)
        type: integer
        min: 0
        max: 2147483647
        default: -1
      images:
        order: 3
        title: en=Images;ru=Изображения
        description: en=Reference images (up to 3, aspect ratio 0.5-2). Use with tags to reference in prompt.;ru=Референсные изображения (до 3, соотношение сторон 0.5-2). Используйте с тегами для ссылок в промпте.
        type: image[]
        featured: true
        max: 2
      tags:
        order: 4
        title: en=Tags;ru=Теги
        description: en=Should be in order your images;ru=Должны быть в порядке ваших изображений
        type: string
        multiline: true
        placeholder: "@cat @dog"
        default: "@cat"
    outputs:
      image:
        title: en=Image;ru=Изображение
        type: image
        featured: true
    catalog:
      _id: runway_gen4_image_replicate
      version: 15
      category:
        _id: generate_images
        title: en=Generate Images;ru=Ген. изображений
        icon: image
        order: 5
      package: replicate
    environment:
      REPLICATE_TOKEN:
        title: Replicate Token
        description: Go to [Replicate](https://replicate.com/account/api-tokens) to take a keys
        type: string
        scope: global
  seedream:
    version: 0
    title: Bytedance Seedream
    description: Generate high-resolution images with Seedream 4 and 4.5 models
    thumbnail: https://huggingface.co/PiperMy/Pipelines/resolve/main/assets/logos/replicate_logo.svg
    tags:
      - text-to-image
      - image-to-image
    execution: regular
    script: |
      export async function costs({ env, inputs }) {
        if (env.scope.REPLICATE_TOKEN === "user") {
          return 0;
        }
        const { model = "seedream_4" } = inputs;
        switch (model) {
          case "seedream_4_5":
            return 0.04;
          case "seedream_4":
          default:
            return 0.03;
        }
      }

      const CHECK_INTERVAL = 2000;
      const MAX_RETRIES = 90;
      const ENDPOINTS = {
        seedream_4: "bytedance/seedream-4",
        seedream_4_5: "bytedance/seedream-4.5",
      };

      function catchError(error) {
        const { throwError } = require("@piper/node");

        const errorData = error.response?.data;
        const message =
          errorData?.detail || errorData?.error || error.message || error;
        if (message?.includes("E005") || message?.includes("sensitive")) {
          throwError.fatal(
            "Content flagged as sensitive. Please try different prompt.",
          );
        }

        throwError.fatal(message);
      }

      export async function run({ inputs, state, env }) {
        const {
          repeat,
          next,
          throwError,
          httpRequest,
          download,
        } = require("@piper/node");

        const { REPLICATE_TOKEN } = env.variables;
        if (!REPLICATE_TOKEN) {
          throwError.fatal("Please, set your API token for Replicate AI");
        }

        const {
          model = "seedream_4",
          prompt,
          images,
          image_size,
          aspect_ratio,
          width,
          height,
          sequential_image_generation,
          max_images,
          enhance_prompt,
          seed,
        } = inputs;

        if (!state) {
          const payload = {
            prompt,
            width,
            height,
            size: image_size,
            aspect_ratio,
            sequential_image_generation,
            image_input: images,
            enhance_prompt,
            seed,
            max_images,
          };

          console.log(JSON.stringify(payload, null, 2));

          try {
            const {
              data: { id: task },
            } = await httpRequest({
              method: "post",
              url: `https://api.replicate.com/v1/models/${ENDPOINTS[model]}/predictions`,
              data: {
                input: payload,
              },
              headers: {
                Authorization: `Bearer ${REPLICATE_TOKEN}`,
                "Content-Type": "application/json",
              },
            });

            return repeat({
              state: { task },
              delay: CHECK_INTERVAL,
            });
          } catch (err) {
            catchError(err);
          }
        } else {
          const { task, retries = 0 } = state;

          try {
            const { data } = await httpRequest({
              method: "get",
              url: `https://api.replicate.com/v1/predictions/${task}`,
              headers: {
                Authorization: `Bearer ${REPLICATE_TOKEN}`,
                "Content-Type": "application/json",
              },
            });

            const { status, error, output } = data;

            switch (status) {
              case "starting":
              case "processing":
                if (retries >= MAX_RETRIES) {
                  throwError.fatal("Generation timeout exceeded");
                }
                return repeat({
                  state: { task, retries: retries + 1 },
                  progress: {
                    total: MAX_RETRIES,
                    processed: retries,
                  },
                  delay: CHECK_INTERVAL,
                });

              case "failed":
              case "canceled":
                catchError(error);
              case "succeeded": {
                const images = (
                  await Promise.all(output.map((url) => download(url)))
                ).map(({ data }) => data);
                return next({
                  outputs: { images },
                  costs: await costs({ env, inputs }),
                });
              }

              default:
                throwError.fatal(`Unknown status: ${status}`);
            }
          } catch (err) {
            catchError(err);
          }
        }
      }
    sign: 0314281052d8da88aea4418c08b258b6304f609232eb9db9ef22ed79e38ad367
    arrange:
      x: 1110
      y: 950
    groups:
      inputs: {}
    inputs:
      prompt:
        order: 2
        title: en=Prompt;ru=Промпт
        description: en=Text prompt for image generation;ru=Текстовая подсказка для генерации изображения
        type: string
        required: true
        featured: true
        multiline: true
        default: cat astronaut walking at a moon
      seed:
        order: 11
        title: en=Seed;ru=Начальный шум
        description: en=Random seed for reproducible generation;ru=Случайный шум для воспроизводимости
        type: integer
        default: -1
      model:
        order: 1
        title: en=Model;ru=Модель
        description: en=Select Seedream model version;ru=Выберите версию Seedream
        type: string
        default: seedream_4_5
        enum:
          - seedream_4|en=Seedream 4;ru=Seedream 4
          - seedream_4_5|en=Seedream 4.5;ru=Seedream 4.5
      aspect_ratio:
        order: 5
        title: en=Aspect Ratio;ru=Соотношение сторон
        description: en=Image aspect ratio (only used when image_size is not 'custom');ru=Соотношение сторон изображения (используется, если разрешение не custom)
        type: string
        default: match_input_image
        enum:
          - match_input_image|en=Match input image;ru=Как у исходного
          - 1:1|en=1:1 (square);ru=1:1 (квадрат)
          - 4:3|en=4:3 (landscape);ru=4:3 (альбом)
          - 3:4|en=3:4 (portrait);ru=3:4 (портрет)
          - 16:9|en=16:9 (wide);ru=16:9 (широкий)
          - 9:16|en=9:16 (vertical);ru=9:16 (вертикальный)
          - 3:2|en=3:2 (landscape);ru=3:2 (альбом)
          - 2:3|en=2:3 (portrait);ru=2:3 (портрет)
          - 21:9|en=21:9 (cinematic);ru=21:9 (кинематографичное)
      width:
        order: 6
        title: en=Width;ru=Ширина
        description: en=Custom width in pixels (only for custom size, 1024-4096);ru=Ширина изображения (для custom размера, 1024-4096)
        type: integer
        min: 1024
        max: 4096
        step: 64
        default: 2048
      height:
        order: 7
        title: en=Height;ru=Высота
        description: en=Custom height in pixels (only for custom size, 1024-4096);ru=Высота изображения (для custom размера, 1024-4096)
        type: integer
        min: 1024
        max: 4096
        step: 64
        default: 2048
      sequential_image_generation:
        order: 8
        title: en=Seq. generation;ru=Послед. генерация
        description: en=Enable multi-image generation mode;ru=Включить режим генерации нескольких изображений
        type: string
        default: disabled
        enum:
          - disabled|en=Disabled;ru=Отключено
          - auto|en=Auto;ru=Авто
      max_images:
        order: 9
        title: en=Max Images;ru=Макс. кол. изобр.
        description: en=Maximum images to generate in auto mode (1-15, total with input ≤ 15);ru=Максимум изображений в авто-режиме (1-15, всего с входными ≤ 15)
        type: integer
        min: 1
        max: 15
        default: 1
      enhance_prompt:
        order: 10
        title: en=Enhance Prompt;ru=Улучшить промпт
        description: en=Enable prompt enhancement for higher quality (only for Seedream 4);ru=Включить улучшение промпта для более высокого качества (только для Seedream 4)
        type: boolean
        default: true
      image_size:
        order: 4
        title: en=Image Size;ru=Размер изображения
        description: en=Image resolution preset (2K, 4K, or custom);ru=Разрешение изображения (2K, 4K или custom)
        type: string
        default: 2K
        enum:
          - 2K|en=2K;ru=2K
          - 4K|en=4K;ru=4K
          - custom|en=Custom;ru=Пользовательский
      images:
        order: 3
        title: en=Images;ru=Изображения
        description: en=Input images for image-to-image generation (1-10 for v4, 1-14 for v4.5);ru=Входные изображения для генерации по изображению (1-10 для v4, 1-14 для v4.5)
        type: image[]
        featured: true
    outputs:
      images:
        title: en=Images;ru=Изображения
        type: image[]
        featured: true
    catalog:
      _id: bytedance_seedream_replicate
      version: 15
      category:
        _id: generate_images
        title: en=Generate Images;ru=Ген. изображений
        icon: image
        order: 5
      package: replicate
    environment:
      REPLICATE_TOKEN:
        title: Replicate Token
        description: Go to [Replicate](https://replicate.com/account/api-tokens) to get your API token
        type: string
        scope: global
  minimax_image_1:
    version: 0
    title: Minimax Image 1
    thumbnail: https://huggingface.co/PiperMy/Pipelines/resolve/main/assets/logos/replicate_logo.svg
    tags:
      - text-to-image
    execution: regular
    script: |
      export async function costs({ env, inputs }) {
        if (env.scope.REPLICATE_TOKEN === "user") {
          return 0;
        }

        const { number_of_images = 1 } = inputs;
        return 0.01 * number_of_images;
      }

      const CHECK_INTERVAL = 2000;
      const MAX_RETRIES = 50;

      function catchError(error) {
        const { throwError } = require("@piper/node");

        const errorData = error.response?.data;
        const message =
          errorData?.detail || errorData?.error || error.message || error;
        if (message?.includes("E005") || message?.includes("sensitive")) {
          throwError.fatal(
            "Content flagged as sensitive. Please try different prompt.",
          );
        }

        throwError.fatal(message);
      }

      export async function run({ env, inputs, state }) {
        const {
          repeat,
          next,
          throwError,
          httpRequest,
          download,
        } = require("@piper/node");

        const { REPLICATE_TOKEN } = env.variables;
        if (!REPLICATE_TOKEN) {
          throwError.fatal("Please, set your API token for Replicate AI");
        }

        const {
          prompt,
          aspect_ratio,
          number_of_images,
          prompt_optimizer,
          character,
        } = inputs;

        if (!state) {
          const payload = {
            prompt,
            aspect_ratio,
            number_of_images,
            prompt_optimizer,
            subject_reference: character,
          };

          console.log(JSON.stringify(payload, null, 2));

          try {
            const {
              data: { id: task },
            } = await httpRequest({
              method: "post",
              url: "https://api.replicate.com/v1/models/minimax/image-01/predictions",
              data: {
                input: payload,
              },
              headers: {
                Authorization: `Bearer ${REPLICATE_TOKEN}`,
                "Content-Type": "application/json",
              },
            });

            return repeat({
              state: { task },
              delay: CHECK_INTERVAL,
            });
          } catch (err) {
            catchError(err);
          }
        } else {
          const { task, retries = 0 } = state;

          try {
            const { data } = await httpRequest({
              method: "get",
              url: `https://api.replicate.com/v1/predictions/${task}`,
              headers: {
                Authorization: `Bearer ${REPLICATE_TOKEN}`,
                "Content-Type": "application/json",
              },
            });

            const { status, error, output } = data;

            switch (status) {
              case "starting":
              case "processing":
                if (retries >= MAX_RETRIES) {
                  throwError.fatal("Generation timeout exceeded");
                }
                return repeat({
                  state: { task, retries: retries + 1 },
                  progress: {
                    total: MAX_RETRIES,
                    processed: retries,
                  },
                  delay: CHECK_INTERVAL,
                });
              case "failed":
              case "canceled":
                catchError(error);
              case "succeeded": {
                const images = (
                  await Promise.all(output.map((url) => download(url)))
                ).map(({ data }) => data);
                return next({
                  outputs: { images },
                  costs: await costs({ env, inputs }),
                });
              }
              default:
                throwError.fatal(`Unknown status: ${status}`);
            }
          } catch (err) {
            catchError(err);
          }
        }
      }
    sign: 88d9035a96cab88d110c8491f608cfdb8cd41c4df04ad89e4ce525f8886f558d
    arrange:
      x: 1110
      y: 1350
    groups:
      inputs: {}
    inputs:
      prompt:
        order: 1
        title: en=Prompt;ru=Промпт
        description: en=Text prompt for generation;ru=Текстовая подсказка для генерации
        type: string
        required: true
        featured: true
        multiline: true
        default: cat astronaut walking at a moon
      aspect_ratio:
        order: 2
        title: en=Aspect ratio;ru=Соотношение сторон
        description: en=Image aspect ratio;ru=Соотношение сторон изображения
        type: string
        default: 1:1
        enum:
          - 1:1|en=1:1;ru=1:1
          - 16:9|en=16:9;ru=16:9
          - 4:3|en=4:3;ru=4:3
          - 3:2|en=3:2;ru=3:2
          - 2:3|en=2:3;ru=2:3
          - 3:4|en=3:4;ru=3:4
          - 9:16|en=9:16;ru=9:16
          - 21:9|en=21:9;ru=21:9
      number_of_images:
        order: 3
        title: en=Images Count;ru=Кол-во изображений
        description: en=Number of images to generate (1-9). Cost is $0.01 per image;ru=Сколько сгенерировать изображений (1-9). Стоимость $0.01 за каждое
        type: integer
        min: 1
        max: 9
        step: 1
        default: 1
      prompt_optimizer:
        order: 4
        title: en=Optimize Prompt;ru=Оптимизировать промпт
        description: en=Use prompt optimizer for better results;ru=Улучшать промпт автоматически
        type: boolean
        default: true
      character:
        order: 5
        title: en=Character;ru=Персонаж
        description: en=Optional character reference image (human face) to use as subject;ru=Референсное изображение персонажа (human face) для портрета
        type: image
        featured: true
    outputs:
      images:
        title: en=Images;ru=Изображения
        type: image[]
        featured: true
    catalog:
      _id: minimax_image_1_replicate
      version: 15
      category:
        _id: generate_images
        title: en=Generate Images;ru=Ген. изображений
        icon: image
        order: 5
      package: replicate
    environment:
      REPLICATE_TOKEN:
        title: Replicate Token
        description: Go to [Replicate](https://replicate.com/account/api-tokens) to take a keys
        type: string
        scope: global
  flux_kontext:
    version: 0
    title: FLUX Kontext
    description: Edit and generate images with FLUX Kontext models
    thumbnail: https://huggingface.co/PiperMy/Pipelines/resolve/main/assets/logos/replicate_logo.svg
    tags:
      - text-to-image
      - image-to-image
    execution: regular
    script: |
      const PRICES = {
        fast: 0.01,
        dev: 0.032,
        pro: 0.04,
        max: 0.08,
      };

      export async function costs({ env, inputs }) {
        if (env.scope.REPLICATE_TOKEN === "user") {
          return 0;
        }
        const { model = "fast" } = inputs;
        return PRICES[model];
      }

      const CHECK_INTERVAL = 2000;
      const MAX_RETRIES = 90;
      const ENDPOINTS = {
        fast: "prunaai/flux-kontext-fast",
        dev: "black-forest-labs/flux-kontext-dev-lora",
        pro: "black-forest-labs/flux-kontext-pro",
        max: "black-forest-labs/flux-kontext-max",
      };

      function catchError(error) {
        const { throwError } = require("@piper/node");

        const errorData = error.response?.data;
        const message =
          errorData?.detail || errorData?.error || error.message || error;
        if (message?.includes("E005") || message?.includes("sensitive")) {
          throwError.fatal(
            "Content flagged as sensitive. Please try different prompt.",
          );
        }

        throwError.fatal(message);
      }

      export async function run({ env, inputs, state }) {
        const {
          repeat,
          next,
          throwError,
          httpRequest,
          download,
        } = require("@piper/node");

        const { REPLICATE_TOKEN } = env.variables;
        if (!REPLICATE_TOKEN) {
          throwError.fatal("Please, set your API token for Replicate AI");
        }

        if (!state) {
          const {
            model = "fast",
            prompt,
            image,
            aspect_ratio,
            seed,
            safety_tolerance,
            prompt_upsampling,
            output_format,
            output_quality,
          } = inputs;

          let payload = {
            prompt,
            img_cond_path: image,
            aspect_ratio,
            seed,
            safety_tolerance,
            prompt_upsampling,
            output_format,
            output_quality,
          };

          console.log(JSON.stringify(payload, null, 2));

          try {
            const {
              data: { id: task },
            } = await httpRequest({
              method: "post",
              url: `https://api.replicate.com/v1/models/${ENDPOINTS[model]}/predictions`,
              data: {
                input: payload,
              },
              headers: {
                Authorization: `Bearer ${REPLICATE_TOKEN}`,
                "Content-Type": "application/json",
              },
            });

            return repeat({
              state: { task },
              delay: CHECK_INTERVAL,
            });
          } catch (err) {
            catchError(err);
          }
        } else {
          const { task, retries = 0 } = state;

          try {
            const { data } = await httpRequest({
              method: "get",
              url: `https://api.replicate.com/v1/predictions/${task}`,
              headers: {
                Authorization: `Bearer ${REPLICATE_TOKEN}`,
                "Content-Type": "application/json",
              },
            });

            const { status, error, output } = data;

            switch (status) {
              case "starting":
              case "processing":
                if (retries >= MAX_RETRIES) {
                  throwError.fatal("Generation timeout exceeded");
                }
                return repeat({
                  state: { task, retries: retries + 1 },
                  progress: {
                    total: MAX_RETRIES,
                    processed: retries,
                  },
                  delay: CHECK_INTERVAL,
                });

              case "failed":
              case "canceled":
                catchError(error);
              case "succeeded": {
                const { data: image } = await download(output);
                return next({
                  outputs: { image },
                  costs: await costs({ env, inputs }),
                });
              }

              default:
                throwError.fatal(`Unknown status: ${status}`);
            }
          } catch (err) {
            catchError(err);
          }
        }
      }
    app: ""
    sign: 614b923e3dc8247a6d5fa4a115eff4ef2b110fe31948e8407c899e2daf1ddf05
    arrange:
      x: 1560
      y: 990
    groups:
      inputs: {}
    inputs:
      prompt:
        order: 2
        title: en=Prompt;ru=Промпт
        description: en=Text description of what you want to generate, or the instruction on how to edit the given image;ru=Текстовое описание того, что вы хотите сгенерировать, или инструкция, как изменить изображение
        type: string
        required: true
        featured: true
        multiline: true
        default: cat astronaut walking at a moon
      seed:
        order: 5
        title: en=Seed;ru=Начальный шум
        description: en=Random seed for reproducible generation (leave empty for random);ru=Случайное число для воспроизводимости (оставьте пустым для случайного)
        type: integer
        default: -1
      model:
        order: 1
        title: en=Model;ru=Модель
        description: en=Select a FLUX Kontext variant;ru=Выберите вариант FLUX Kontext
        type: string
        default: fast
        enum:
          - fast|en=Fast;ru=Быстрая
          - dev|en=Dev;ru=Разработка
          - pro|en=Pro;ru=Про
          - max|en=Max;ru=Максимум
      aspect_ratio:
        order: 4
        title: en=Aspect Ratio;ru=Соотношение сторон
        description: en=Output image aspect ratio. Use 'match_input_image' to match the input image;ru=Соотношение сторон выходного изображения. Используйте match_input_image, чтобы соответствовать входному изображению
        type: string
        default: match_input_image
        enum:
          - match_input_image|en=Match input image;ru=Как у исходного
          - 1:1|en=1:1;ru=1:1
          - 16:9|en=16:9;ru=16:9
          - 9:16|en=9:16;ru=9:16
          - 4:3|en=4:3;ru=4:3
          - 3:4|en=3:4;ru=3:4
          - 3:2|en=3:2;ru=3:2
          - 2:3|en=2:3;ru=2:3
          - 4:5|en=4:5;ru=4:5
          - 5:4|en=5:4;ru=5:4
          - 21:9|en=21:9;ru=21:9
          - 9:21|en=9:21;ru=9:21
          - 2:1|en=2:1;ru=2:1
          - 1:2|en=1:2;ru=1:2
      safety_tolerance:
        order: 6
        title: en=Safety Tolerance;ru=Толер. безоп.
        description: en=Safety tolerance (0 = strictest, 6 = most permissive, applies to Pro/Max);ru=Толер. безоп. (0 = строго, 6 = наиболее разрешено; применяется к Pro/Max)
        type: integer
        min: 0
        max: 6
        step: 1
        default: 2
      prompt_upsampling:
        order: 7
        title: en=Prompt Upsampling;ru=Улучшение подсказки
        description: en=Automatic prompt improvement. Applies to Pro/Max;ru=Автоматическое улучшение подсказки. Применяется для Pro/Max
        type: boolean
        default: false
      output_format:
        order: 8
        title: en=Output Format;ru=Формат вывода
        description: en=Output format. Pro/Max support jpg/png; webp will be converted to png;ru=Формат вывода. Pro/Max поддерживает jpg/png; webp будет преобразован в png
        type: string
        default: webp
        enum:
          - webp|en=WebP;ru=WebP
          - jpg|en=JPG;ru=JPG
          - png|en=PNG;ru=PNG
      output_quality:
        order: 9
        title: en=Output Quality;ru=Качество вывода
        description: en=Quality when saving the output (0-100, not relevant for PNG). Used for Dev/Fast;ru=Качество при сохранении результата (0-100, не влияет для PNG). Используется для Dev/Fast
        type: integer
        min: 0
        max: 100
        default: 80
      image:
        order: 3
        title: en=Image;ru=Изображение
        description: en=Reference image (required for Fast, optional for other models);ru=Референсное изображение (обязательно для Fast, опционально для других моделей)
        type: image
        featured: true
    outputs:
      image:
        title: en=Image;ru=Изображение
        type: image
        featured: true
    catalog:
      _id: flux_kontext_replicate
      version: 15
      category:
        _id: generate_images
        title: en=Generate Images;ru=Ген. изображений
        icon: image
        order: 5
      package: replicate
    environment:
      REPLICATE_TOKEN:
        title: Replicate Token
        description: Go to [Replicate](https://replicate.com/account/api-tokens) to get your API token
        type: string
        scope: global
  luma_photon:
    version: 0
    title: Luma Photon
    thumbnail: https://huggingface.co/PiperMy/Pipelines/resolve/main/assets/logos/replicate_logo.svg
    tags:
      - text-to-image
      - image-to-image
    execution: regular
    script: |
      export async function costs({ env }) {
        if (env.scope.REPLICATE_TOKEN === "user") {
          return 0;
        }
        return 0.03;
      }

      const CHECK_INTERVAL = 2000;
      const MAX_RETRIES = 40;

      function catchError(error) {
        const { throwError } = require("@piper/node");

        const errorData = error.response?.data;
        const message =
          errorData?.detail || errorData?.error || error.message || error;
        if (message?.includes("E005") || message?.includes("sensitive")) {
          throwError.fatal(
            "Content flagged as sensitive. Please try different prompt.",
          );
        }

        throwError.fatal(message);
      }

      export async function run({ env, inputs, state }) {
        const {
          repeat,
          next,
          throwError,
          httpRequest,
          download,
        } = require("@piper/node");

        const { REPLICATE_TOKEN } = env.variables;
        if (!REPLICATE_TOKEN) {
          throwError.fatal("Please, set your API token for Replicate AI");
        }

        if (!state) {
          const {
            prompt,
            aspect_ratio,
            seed,
            image_reference,
            style_reference,
            character_reference,
            image_reference_weight,
            style_reference_weight,
          } = inputs;

          const payload = {
            prompt,
            aspect_ratio,
            seed,
            image_reference,
            style_reference,
            character_reference,
            image_reference_weight,
            style_reference_weight,
          };

          console.log(JSON.stringify(payload, null, 2));

          try {
            const {
              data: { id: task },
            } = await httpRequest({
              method: "post",
              url: "https://api.replicate.com/v1/models/luma/photon/predictions",
              data: {
                input: payload,
              },
              headers: {
                Authorization: `Bearer ${REPLICATE_TOKEN}`,
                "Content-Type": "application/json",
              },
            });

            return repeat({
              state: { task },
              delay: CHECK_INTERVAL,
            });
          } catch (err) {
            catchError(err);
          }
        } else {
          const { task, retries = 0 } = state;

          try {
            const { data } = await httpRequest({
              method: "get",
              url: `https://api.replicate.com/v1/predictions/${task}` ,
              headers: {
                Authorization: `Bearer ${REPLICATE_TOKEN}` ,
                "Content-Type": "application/json",
              },
            });

            const { status, error, output } = data;

            switch (status) {
              case "starting":
              case "processing":
                if (retries >= MAX_RETRIES) {
                  throwError.fatal("Generation timeout exceeded");
                }
                return repeat({
                  state: { task, retries: retries + 1 },
                  progress: {
                    total: MAX_RETRIES,
                    processed: retries,
                  },
                  delay: CHECK_INTERVAL,
                });

              case "failed":
              case "canceled":
                catchError(error);
              case "succeeded": {
                const { data: image } = await download(output);
                return next({
                  outputs: { image },
                  costs: await costs({ env }),
                });
              }

              default:
                throwError.fatal(`Unknown status: ${status}`);
            }
          } catch (err) {
            catchError(err);
          }
        }
      }
    sign: 335c196e7689c038e4bc4d185c06695e857203d4a4545c06b8984b328d21149c
    arrange:
      x: 1730
      y: 1470
    groups:
      inputs: {}
    inputs:
      prompt:
        order: 1
        title: en=Prompt;ru=Промпт
        description: en=Text prompt for image generation;ru=Текстовая подсказка для генерации изображения
        type: string
        required: true
        featured: true
        multiline: true
        default: cat astronaut walking at a moon
      aspect_ratio:
        order: 2
        title: en=Aspect Ratio;ru=Соотношение сторон
        description: en=Aspect ratio of the generated image;ru=Соотношение сторон итогового изображения
        type: string
        default: 16:9
        enum:
          - 1:1|en=1:1 (square);ru=1:1 (квадрат)
          - 3:4|en=3:4 (portrait);ru=3:4 (портрет)
          - 4:3|en=4:3 (landscape);ru=4:3 (альбом)
          - 9:16|en=9:16 (vertical);ru=9:16 (вертикально)
          - 16:9|en=16:9 (wide);ru=16:9 (широкий)
          - 9:21|en=9:21;ru=9:21
          - 21:9|en=21:9;ru=21:9
      seed:
        order: 3
        title: en=Seed;ru=Начальный шум
        description: en=Random seed for reproducible generation (leave empty for random);ru=Случайный шум для воспроизводимости (оставьте пустым для случайного)
        type: integer
        min: 0
        max: 2147483647
        default: -1
      image_reference:
        order: 4
        title: en=Image;ru=Изображение
        description: en=Reference image to guide generation;ru=Референс для генерации изображения
        type: image
      image_reference_weight:
        order: 5
        title: en=Image Weight;ru=Вес изобр.
        description: en=Weight of the reference image (0-1). Higher values = stronger influence;ru=Влияние референса (0-1, больше - сильнее)
        type: float
        min: 0
        max: 1
        step: 0.05
        default: 0.85
      style_reference:
        order: 6
        title: en=Style;ru=Стиль
        description: en=Style reference image to guide generation;ru=Референс для стиля
        type: image
      style_reference_weight:
        order: 7
        title: en=Style Weight;ru=Вес стиля
        description: en=Weight of the style reference (0-1). Higher values = stronger influence;ru=Влияние референса стиля (0-1, больше - сильнее)
        type: float
        min: 0
        max: 1
        step: 0.05
        default: 0.85
      character_reference:
        order: 8
        title: en=Character;ru=Персонаж
        description: en=Character reference image to guide generation;ru=Референсное изображение персонажа для генерации
        type: image
    outputs:
      image:
        title: en=Image;ru=Изображение
        type: image
        featured: true
    catalog:
      _id: luma_photon_replicate
      version: 15
      category:
        _id: generate_images
        title: en=Generate Images;ru=Ген. изображений
        icon: image
        order: 5
      package: replicate
    environment:
      REPLICATE_TOKEN:
        title: Replicate Token
        description: Go to [Replicate](https://replicate.com/account/api-tokens) to take a keys
        type: string
        scope: global
  ideogram_v3_character:
    version: 0
    title: Ideogram V3 Character
    thumbnail: https://huggingface.co/PiperMy/Pipelines/resolve/main/assets/logos/replicate_logo.svg
    tags:
      - text-to-image
      - image-to-image
    execution: regular
    script: |
      export async function costs({ env, inputs }) {
        if (env.scope.REPLICATE_TOKEN === "user") {
          return 0;
        }
        const { rendering_speed = "Default" } = inputs;
        switch (rendering_speed) {
          case "Turbo":
            return 0.1;
          case "Default":
            return 0.15;
          case "Quality":
            return 0.2;
          default:
            return 0.15;
        }
      }

      const CHECK_INTERVAL = 2000;
      const MAX_RETRIES = 50;

      function catchError(error) {
        const { throwError } = require("@piper/node");

        const errorData = error.response?.data;
        const message =
          errorData?.detail || errorData?.error || error.message || error;
        if (message?.includes("E005") || message?.includes("sensitive")) {
          throwError.fatal(
            "Content flagged as sensitive. Please try different prompt.",
          );
        }

        throwError.fatal(message);
      }

      export async function run({ env, inputs, state }) {
        const {
          repeat,
          next,
          throwError,
          httpRequest,
          download,
        } = require("@piper/node");

        const { REPLICATE_TOKEN } = env.variables;
        if (!REPLICATE_TOKEN) {
          throwError.fatal("Please, set your API token for Replicate AI");
        }

        if (!state) {
          const {
            prompt,
            character_reference_image,
            rendering_speed,
            style_type,
            aspect_ratio,
            resolution,
            magic_prompt_option,
            seed,
            image,
            mask,
          } = inputs;

          const payload = {
            prompt,
            character_reference_image,
            rendering_speed,
            style_type,
            aspect_ratio,
            resolution,
            magic_prompt_option,
            seed,
            image,
            mask,
          };

          console.log(JSON.stringify(payload, null, 2));

          try {
            const {
              data: { id: task },
            } = await httpRequest({
              method: "post",
              url: "https://api.replicate.com/v1/models/ideogram-ai/ideogram-character/predictions",
              data: {
                input: payload,
              },
              headers: {
                Authorization: `Bearer ${REPLICATE_TOKEN}`,
                "Content-Type": "application/json",
              },
            });

            return repeat({
              state: { task },
              delay: CHECK_INTERVAL,
            });
          } catch (err) {
            catchError(err);
          }
        } else {
          const { task, retries = 0 } = state;

          try {
            const { data } = await httpRequest({
              method: "get",
              url: `https://api.replicate.com/v1/predictions/${task}`,
              headers: {
                Authorization: `Bearer ${REPLICATE_TOKEN}`,
                "Content-Type": "application/json",
              },
            });

            const { status, error, output } = data;

            switch (status) {
              case "starting":
              case "processing":
                if (retries >= MAX_RETRIES) {
                  throwError.fatal("Generation timeout exceeded");
                }
                return repeat({
                  state: { task, retries: retries + 1 },
                  progress: {
                    total: MAX_RETRIES,
                    processed: retries,
                  },
                  delay: CHECK_INTERVAL,
                });

              case "failed":
              case "canceled":
                catchError(error);
              case "succeeded": {
                const { data: image } = await download(output);
                return next({
                  outputs: { image },
                  costs: await costs({ env, inputs }),
                });
              }

              default:
                throwError.fatal(`Unknown status: ${status}`);
            }
          } catch (err) {
            catchError(err);
          }
        }
      }
    sign: 2e2cb5e5583baa48f0588ffcf1de58faf248ed3fe8a9e8256c4405dd8e0dbd03
    arrange:
      x: 1520
      y: 550
    groups:
      inputs: {}
    inputs:
      prompt:
        order: 1
        title: en=Prompt;ru=Промпт
        description: en=Text prompt for image generation;ru=Текстовая подсказка для генерации изображения
        type: string
        required: true
        featured: true
        multiline: true
        default: cat astronaut walking at a moon
      character_reference_image:
        order: 2
        title: en=Character;ru=Персонаж
        description: en=Reference image for character consistency;ru=Референсное изображение для постоянства персонажа
        type: image
        required: true
        featured: true
      rendering_speed:
        order: 3
        title: en=Rendering Speed;ru=Скорость рендеринга
        description: en=Speed vs quality trade-off;ru=Баланс между скоростью и качеством
        type: string
        default: Default
        enum:
          - Turbo|en=Turbo;ru=Турбо
          - Default|en=Default;ru=Обычная
          - Quality|en=Quality;ru=Качество
      style_type:
        order: 4
        title: en=Style Type;ru=Тип стиля
        description: en=Character style type;ru=Тип стиля персонажа
        type: string
        default: Auto
        enum:
          - Auto|en=Auto;ru=Авто
          - Fiction|en=Fiction;ru=Вымышленный
          - Realistic|en=Realistic;ru=Реалистичный
      aspect_ratio:
        order: 5
        title: en=Aspect Ratio;ru=Соотношение сторон
        description: en=Aspect ratio (ignored if resolution or inpainting image is set);ru=Соотношение сторон (игнорируется если задано разрешение или inpainting изображение)
        type: string
        default: 1:1
        enum:
          - 1:3|en=1:3;ru=1:3
          - 3:1|en=3:1;ru=3:1
          - 1:2|en=1:2;ru=1:2
          - 2:1|en=2:1;ru=2:1
          - 9:16|en=9:16;ru=9:16
          - 16:9|en=16:9;ru=16:9
          - 10:16|en=10:16;ru=10:16
          - 16:10|en=16:10;ru=16:10
          - 2:3|en=2:3;ru=2:3
          - 3:2|en=3:2;ru=3:2
          - 3:4|en=3:4;ru=3:4
          - 4:3|en=4:3;ru=4:3
          - 4:5|en=4:5;ru=4:5
          - 5:4|en=5:4;ru=5:4
          - 1:1|en=1:1;ru=1:1
      resolution:
        order: 6
        title: en=Resolution;ru=Разрешение
        description: en=Specific resolution (overrides aspect ratio, ignored for inpainting);ru=Определённое разрешение (заменяет соотношение сторон, игнорируется при inpainting)
        type: string
        default: None
        enum:
          - None|en=None;ru=Нет
          - 512x1536
          - 576x1408
          - 576x1472
          - 576x1536
          - 640x1344
          - 640x1408
          - 640x1472
          - 640x1536
          - 704x1152
          - 704x1216
          - 704x1280
          - 704x1344
          - 704x1408
          - 704x1472
          - 736x1312
          - 768x1088
          - 768x1216
          - 768x1280
          - 768x1344
          - 800x1280
          - 832x960
          - 832x1024
          - 832x1088
          - 832x1152
          - 832x1216
          - 832x1248
          - 864x1152
          - 896x960
          - 896x1024
          - 896x1088
          - 896x1120
          - 896x1152
          - 960x832
          - 960x896
          - 960x1024
          - 960x1088
          - 1024x832
          - 1024x896
          - 1024x960
          - 1024x1024
          - 1088x768
          - 1088x832
          - 1088x896
          - 1088x960
          - 1120x896
          - 1152x704
          - 1152x832
          - 1152x864
          - 1152x896
          - 1216x704
          - 1216x768
          - 1216x832
          - 1248x832
          - 1280x704
          - 1280x768
          - 1280x800
          - 1312x736
          - 1344x640
          - 1344x704
          - 1344x768
          - 1408x576
          - 1408x640
          - 1408x704
          - 1472x576
          - 1472x640
          - 1472x704
          - 1536x512
          - 1536x576
          - 1536x640
      magic_prompt_option:
        order: 7
        title: en=Magic Prompt;ru=Магический промпт
        description: en=Optimize and enhance your prompt automatically;ru=Автоматическая оптимизация и улучшение промпта
        type: string
        default: Auto
        enum:
          - Auto|en=Auto;ru=Авто
          - On|en=On;ru=Включить
          - Off|en=Off;ru=Выключить
      seed:
        order: 8
        title: en=Seed;ru=Начальный шум
        description: en=Random seed for reproducible generation (leave empty for random);ru=Случайный шум для воспроизводимости (оставьте пустым для случайного)
        type: integer
        min: 0
        max: 2147483647
        default: -1
      image:
        order: 9
        title: en=Inpainting Image;ru=Изобр. для дорисовки
        description: en=Image for inpainting (requires mask);ru=Изображение для inpainting (требует маску)
        type: image
      mask:
        order: 10
        title: en=Inpainting Mask;ru=Маска для дорисовки
        description: en=Black and white mask (black = inpaint, white = preserve, requires image);ru=Чёрно-белая маска (чёрное = дорисовать, белое = сохранить, требует изображение)
        type: image
    outputs:
      image:
        title: en=Image;ru=Изображение
        type: image
        featured: true
    catalog:
      _id: ideogram_v3_character_replicate
      version: 15
      category:
        _id: generate_images
        title: en=Generate Images;ru=Ген. изображений
        icon: image
        order: 5
      package: replicate
    environment:
      REPLICATE_TOKEN:
        title: Replicate Token
        description: Go to [Replicate](https://replicate.com/account/api-tokens) to take a keys
        type: string
        scope: global
  nano_banana:
    version: 0
    title: Google Nano Banana
    thumbnail: https://huggingface.co/PiperMy/Pipelines/resolve/main/assets/logos/replicate_logo.svg
    tags:
      - text-to-image
      - image-to-image
    execution: regular
    script: |
      export async function costs({ env }) {
        if (env.scope.REPLICATE_TOKEN === "user") {
          return 0;
        }
        return 0.04;
      }

      const CHECK_INTERVAL = 2000;
      const MAX_RETRIES = 30;

      function catchError(error) {
        const { throwError } = require("@piper/node");

        const errorData = error.response?.data;
        const message =
          errorData?.detail || errorData?.error || error.message || error;
        if (message?.includes("E005") || message?.includes("sensitive")) {
          throwError.fatal(
            "Content flagged as sensitive. Please try different prompt.",
          );
        }

        throwError.fatal(message);
      }

      export async function run({ env, inputs, state }) {
        const {
          repeat,
          next,
          throwError,
          httpRequest,
          download,
        } = require("@piper/node");

        const { REPLICATE_TOKEN } = env.variables;
        if (!REPLICATE_TOKEN) {
          throwError.fatal("Please, set your API token for Replicate AI");
        }

        if (!state) {
          const {
            prompt,
            images,
            aspect_ratio,
            output_format,
          } = inputs;

          const payload = {
            prompt,
            image_input: images,
            aspect_ratio,
            output_format,
          };

          console.log(JSON.stringify(payload, null, 2));

          try {
            const {
              data: { id: task },
            } = await httpRequest({
              method: "post",
              url: "https://api.replicate.com/v1/models/google/nano-banana/predictions",
              data: {
                input: payload,
              },
              headers: {
                Authorization: `Bearer ${REPLICATE_TOKEN}`,
                "Content-Type": "application/json",
              },
            });

            return repeat({
              state: { task },
              delay: CHECK_INTERVAL,
            });
          } catch (err) {
            catchError(err);
          }
        } else {
          const { task, retries = 0 } = state;

          try {
            const { data } = await httpRequest({
              method: "get",
              url: `https://api.replicate.com/v1/predictions/${task}`,
              headers: {
                Authorization: `Bearer ${REPLICATE_TOKEN}` ,
                "Content-Type": "application/json",
              },
            });

            const { status, error, output } = data;

            switch (status) {
              case "starting":
              case "processing":
                if (retries >= MAX_RETRIES) {
                  throwError.fatal("Generation timeout exceeded");
                }
                return repeat({
                  state: { task, retries: retries + 1 },
                  progress: {
                    total: MAX_RETRIES,
                    processed: retries,
                  },
                  delay: CHECK_INTERVAL,
                });

              case "failed":
              case "canceled":
                catchError(error);
              case "succeeded": {
                const { data: image } = await download(output);
                return next({
                  outputs: { image },
                  costs: await costs({ env }),
                });
              }

              default:
                throwError.fatal(`Unknown status: ${status}`);
            }
          } catch (err) {
            catchError(err);
          }
        }
      }
    app: ""
    sign: 4002155903e9f7167774cad0f60cf017d23f90a80aeac2e98f9df77ca0e7e889
    arrange:
      x: 2070
      y: 980
    groups:
      inputs: {}
    inputs:
      prompt:
        order: 1
        title: en=Prompt;ru=Промпт
        description: en=A text description of the image you want to generate;ru=Текстовое описание изображения, которое вы хотите сгенерировать
        type: string
        required: true
        featured: true
        multiline: true
        default: cat astronaut walking at a moon
      images:
        order: 2
        title: en=Images;ru=Изображения
        description: en=Input images to transform or use as reference (supports multiple images);ru=Входные изображения для трансформации или в качестве референса (поддерживается несколько изображений)
        type: image[]
        featured: true
      aspect_ratio:
        order: 3
        title: en=Aspect Ratio;ru=Соотношение сторон
        description: en=Aspect ratio of the generated image;ru=Соотношение сторон создаваемого изображения
        type: string
        default: match_input_image
        enum:
          - match_input_image|en=Match image;ru=Как у изображения
          - 1:1|en=1:1 <Square>;ru=1:1 <Квадрат>
          - 2:3|en=2:3 <Portrait>;ru=2:3 <Портрет>
          - 3:2|en=3:2 <Landscape>;ru=3:2 <Пейзаж>
          - 3:4|en=3:4 <Portrait>;ru=3:4 <Портрет>
          - 4:3|en=4:3 <Landscape>;ru=4:3 <Пейзаж>
          - 4:5|en=4:5 <Portrait>;ru=4:5 <Портрет>
          - 5:4|en=5:4 <Landscape>;ru=5:4 <Пейзаж>
          - 9:16|en=9:16 <Portrait>;ru=9:16 <Портрет>
          - 16:9|en=16:9 <Landscape>;ru=16:9 <Пейзаж>
          - 21:9|en=21:9 <Landscape>;ru=21:9 <Пейзаж>
      output_format:
        order: 4
        title: en=Output Format;ru=Формат вывода
        description: en=Format of the output image;ru=Формат итогового изображения
        type: string
        default: jpg
        enum:
          - jpg|en=JPG;ru=JPG
          - png|en=PNG;ru=PNG
    outputs:
      image:
        title: en=Image;ru=Изображение
        type: image
        featured: true
    catalog:
      _id: google_nano_banana_replicate
      version: 15
      category:
        _id: generate_images
        title: en=Generate Images;ru=Ген. изображений
        icon: image
        order: 5
      package: replicate
    environment:
      REPLICATE_TOKEN:
        title: Replicate Token
        description: Go to [Replicate](https://replicate.com/account/api-tokens) to take a keys
        type: string
        scope: global
  nano_banana_pro:
    version: 0
    title: Google Nano Banana Pro
    thumbnail: https://huggingface.co/PiperMy/Pipelines/resolve/main/assets/logos/replicate_logo.svg
    tags:
      - text-to-image
      - image-to-image
    execution: regular
    script: |
      export async function costs({ env, inputs }) {
        if (env.scope.REPLICATE_TOKEN === "user") {
          return 0;
        }

        const { resolution = "2K" } = inputs;
        switch (resolution) {
          case "1K":
            return 0.14;
          case "2K":
            return 0.14;
          case "4K":
            return 0.24;
          default:
            return 0.14;
        }
      }

      const CHECK_INTERVAL = 2000;
      const MAX_RETRIES = 60;

      function catchError(error) {
        const { throwError } = require("@piper/node");

        const errorData = error.response?.data;
        const message =
          errorData?.detail || errorData?.error || error.message || error;
        if (message?.includes("E005") || message?.includes("sensitive")) {
          throwError.fatal(
            "Content flagged as sensitive. Please try different prompt.",
          );
        }

        throwError.fatal(message);
      }

      export async function run({ env, inputs, state }) {
        const {
          repeat,
          next,
          throwError,
          httpRequest,
          download,
        } = require("@piper/node");

        const { REPLICATE_TOKEN } = env.variables;
        if (!REPLICATE_TOKEN) {
          throwError.fatal("Please, set your API token for Replicate AI");
        }

        if (!state) {
          const {
            prompt,
            images,
            aspect_ratio,
            resolution,
            output_format,
            safety_filter_level,
          } = inputs;

          const payload = {
            prompt,
            image_input: images,
            aspect_ratio,
            resolution,
            output_format,
            safety_filter_level,
          };

          console.log(JSON.stringify(payload, null, 2));

          try {
            const {
              data: { id: task },
            } = await httpRequest({
              method: "post",
              url: "https://api.replicate.com/v1/models/google/nano-banana-pro/predictions",
              data: {
                input: payload,
              },
              headers: {
                Authorization: `Bearer ${REPLICATE_TOKEN}` ,
                "Content-Type": "application/json",
              },
            });

            return repeat({
              state: { task },
              delay: CHECK_INTERVAL,
            });
          } catch (err) {
            catchError(err);
          }
        } else {
          const { task, retries = 0 } = state;

          try {
            const { data } = await httpRequest({
              method: "get",
              url: `https://api.replicate.com/v1/predictions/${task}` ,
              headers: {
                Authorization: `Bearer ${REPLICATE_TOKEN}` ,
                "Content-Type": "application/json",
              },
            });

            const { status, error, output } = data;

            switch (status) {
              case "starting":
              case "processing":
                if (retries >= MAX_RETRIES) {
                  throwError.fatal("Generation timeout exceeded");
                }
                return repeat({
                  state: { task, retries: retries + 1 },
                  progress: {
                    total: MAX_RETRIES,
                    processed: retries,
                  },
                  delay: CHECK_INTERVAL,
                });

              case "failed":
              case "canceled":
                catchError(error);
              case "succeeded": {
                const { data: image } = await download(output);
                return next({
                  outputs: { image },
                  costs: await costs({ env, inputs }),
                });
              }

              default:
                throwError.fatal(`Unknown status: ${status}`);
            }
          } catch (err) {
            catchError(err);
          }
        }
      }
    sign: 197103c8f7d465090eab5e3e93842c034ae53643e8160da5b1ee54367372c87c
    arrange:
      x: 2180
      y: 1380
    groups:
      inputs: {}
    inputs:
      prompt:
        order: 1
        title: en=Prompt;ru=Промпт
        description: en=A text description of the image you want to generate;ru=Текстовое описание изображения, которое вы хотите сгенерировать
        type: string
        required: true
        featured: true
        multiline: true
        default: cat astronaut walking at a moon
      aspect_ratio:
        order: 3
        title: en=Aspect Ratio;ru=Соотношение сторон
        description: en=Aspect ratio of the generated image;ru=Соотношение сторон создаваемого изображения
        type: string
        default: match_input_image
        enum:
          - match_input_image|en=Match image;ru=Как у изображения
          - 1:1|en=1:1 <Square>
          - 2:3|en=2:3 <Portrait>
          - 3:2|en=3:2 <Landscape>
          - 3:4|en=3:4 <Portrait>
          - 4:3|en=4:3 <Landscape>
          - 4:5|en=4:5 <Portrait>
          - 5:4|en=5:4 <Landscape>
          - 9:16|en=9:16 <Portrait>
          - 16:9|en=16:9 <Landscape>
          - 21:9|en=21:9 <Landscape>
      resolution:
        order: 4
        title: en=Resolution;ru=Разрешение
        description: en=Resolution of the generated image (1K/2K = $0.14, 4K = $0.24);ru=Разрешение итогового изображения (1K/2K = $0.14, 4K = $0.24)
        type: string
        default: 2K
        enum:
          - 1K|en=1K;ru=1K
          - 2K|en=2K;ru=2K
          - 4K|en=4K;ru=4K
      output_format:
        order: 5
        title: en=Output Format;ru=Формат вывода
        description: en=Format of the output image;ru=Формат итогового изображения
        type: string
        default: jpg
        enum:
          - jpg|en=JPG;ru=JPG
          - png|en=PNG;ru=PNG
      safety_filter_level:
        order: 6
        title: en=Safety Filter Level;ru=Уровень фильтра контента
        description: en=Content safety filter strictness;ru=Строгость фильтра безопасности контента
        type: string
        default: block_only_high
        enum:
          - block_low_and_above|en=Block low and above;ru=Блокировать низкий и выше
          - block_medium_and_above|en=Block medium and above;ru=Блокировать средний и выше
          - block_only_high|en=Block only high;ru=Блокировать только высокий
      images:
        order: 2
        title: en=Images;ru=Изображения
        description: en=Optional reference images (up to 14 images supported);ru=Референсные изображения (до 14 штук)
        type: image[]
        featured: true
    outputs:
      image:
        title: en=Image;ru=Изображение
        type: image
        featured: true
    catalog:
      _id: google_nano_banana_pro_replicate
      version: 15
      category:
        _id: generate_images
        title: en=Generate Images;ru=Ген. изображений
        icon: image
        order: 5
      package: replicate
    environment:
      REPLICATE_TOKEN:
        title: Replicate Token
        description: Go to [Replicate](https://replicate.com/account/api-tokens) to take a keys
        type: string
        scope: global
